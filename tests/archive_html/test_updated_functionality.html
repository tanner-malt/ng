<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Updated Functionality Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #2c3e50; 
            color: white; 
            line-height: 1.6;
        }
        .test-section { 
            background: #34495e; 
            padding: 20px; 
            margin: 15px 0; 
            border-radius: 8px; 
            border-left: 4px solid #3498db;
        }
        .success { border-left-color: #27ae60; }
        .error { border-left-color: #e74c3c; }
        .warning { border-left-color: #f39c12; }
        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-size: 14px;
        }
        button:hover { background: #2980b9; }
        .production-display {
            background: #2c3e50;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #34495e;
        }
    </style>
</head>
<body>
    <h1>üß™ Updated Functionality Test</h1>
    <p>Testing the new production/consumption display, death estimates, and exploration achievement.</p>

    <div class="test-section">
        <h2>üìä Production & Consumption Display</h2>
        <button onclick="testProductionCalculations()">Test Production Calculations</button>
        <button onclick="testConsumptionCalculations()">Test Consumption Calculations</button>
        <div id="production-results"></div>
    </div>

    <div class="test-section">
        <h2>üë• Population Display</h2>
        <button onclick="setupTestPopulation()">Setup Test Population</button>
        <button onclick="testPopulationDisplay()">Test Population Display</button>
        <div id="population-results"></div>
    </div>

    <div class="test-section">
        <h2>üó∫Ô∏è Exploration Achievement</h2>
        <button onclick="testExplorationAchievement()">Test Exploration Achievement</button>
        <button onclick="checkMetalReward()">Check Metal Reward</button>
        <div id="exploration-results"></div>
    </div>

    <div class="test-section">
        <h2>‚öíÔ∏è Blacksmith Building</h2>
        <button onclick="testBlacksmithBuilding()">Test Blacksmith Building</button>
        <div id="blacksmith-results"></div>
    </div>

    <!-- Load all game scripts -->
    <script src="src/systems/core/eventBus.js"></script>
    <script src="src/gameData.js"></script>
    <script src="src/populationManager.js"></script>
    <script src="src/achievements.js"></script>
    <script src="src/gameState.js"></script>
    <script src="src/modalSystem.js"></script>
    <script src="src/village.js"></script>
    <script src="src/worldManager.js"></script>

    <script>
        let testGameState = null;
        
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                console.log('üß™ Starting updated functionality tests...');
                
                // Initialize test game state
                testGameState = new GameState();
                console.log('Test GameState initialized:', testGameState);
                
                // Set global reference
                window.gameState = testGameState;
                
            }, 1000);
        });

        function testProductionCalculations() {
            const results = document.getElementById('production-results');
            let output = '<h3>Production Calculation Results:</h3>';
            
            try {
                if (testGameState) {
                    // Add some test buildings
                    testGameState.buildings = [
                        { id: 'tc1', type: 'townCenter', x: 100, y: 100, level: 1 },
                        { id: 'farm1', type: 'farm', x: 150, y: 100, level: 1 },
                        { id: 'quarry1', type: 'quarry', x: 200, y: 100, level: 1 },
                        { id: 'blacksmith1', type: 'blacksmith', x: 250, y: 100, level: 1 }
                    ];
                    
                    // Test production calculation
                    const production = testGameState.calculateDailyProduction();
                    output += `<div class="production-display">
                        <h4>Daily Production:</h4>
                        <div class="stat-row"><span>üåæ Food:</span><span>${production.food}</span></div>
                        <div class="stat-row"><span>ü™µ Wood:</span><span>${production.wood}</span></div>
                        <div class="stat-row"><span>üóø Stone:</span><span>${production.stone}</span></div>
                        <div class="stat-row"><span>‚öíÔ∏è Metal:</span><span>${production.metal}</span></div>
                    </div>`;
                    
                    // Test consumption calculation
                    const consumption = testGameState.calculateDailyConsumption();
                    output += `<div class="production-display">
                        <h4>Daily Consumption:</h4>
                        <div class="stat-row"><span>üåæ Food:</span><span>${consumption.food}</span></div>
                        <div class="stat-row"><span>ü™µ Wood:</span><span>${consumption.wood}</span></div>
                        <div class="stat-row"><span>üóø Stone:</span><span>${consumption.stone}</span></div>
                        <div class="stat-row"><span>‚öíÔ∏è Metal:</span><span>${consumption.metal}</span></div>
                    </div>`;
                    
                    // Calculate net changes
                    const netFood = production.food - consumption.food;
                    const netWood = production.wood - consumption.wood;
                    const netStone = production.stone - consumption.stone;
                    const netMetal = production.metal - consumption.metal;
                    
                    output += `<div class="production-display">
                        <h4>Net Changes:</h4>
                        <div class="stat-row"><span>üåæ Food:</span><span>${netFood >= 0 ? '+' : ''}${netFood}</span></div>
                        <div class="stat-row"><span>ü™µ Wood:</span><span>${netWood >= 0 ? '+' : ''}${netWood}</span></div>
                        <div class="stat-row"><span>üóø Stone:</span><span>${netStone >= 0 ? '+' : ''}${netStone}</span></div>
                        <div class="stat-row"><span>‚öíÔ∏è Metal:</span><span>${netMetal >= 0 ? '+' : ''}${netMetal}</span></div>
                    </div>`;
                    
                    output += '<div class="success">‚úÖ Production calculations working correctly</div>';
                    
                } else {
                    output += '<div class="error">‚ùå GameState not available</div>';
                }
            } catch (error) {
                output += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            results.innerHTML = output;
        }

        function testConsumptionCalculations() {
            const results = document.getElementById('production-results');
            let output = results.innerHTML + '<h3>Consumption Detail Analysis:</h3>';
            
            try {
                if (testGameState) {
                    // Set population for testing
                    testGameState.population = 15;
                    
                    const consumption = testGameState.calculateDailyConsumption();
                    
                    output += `<div class="production-display">
                        <h4>Consumption Breakdown:</h4>
                        <div class="stat-row"><span>Population (${testGameState.population}):</span><span>${Math.ceil(testGameState.population / 2)} food</span></div>
                        <div class="stat-row"><span>Building Maintenance:</span><span>Various resources</span></div>
                        <div class="stat-row"><span>Total Food Consumption:</span><span>${consumption.food}</span></div>
                    </div>`;
                    
                    output += '<div class="success">‚úÖ Consumption system working</div>';
                    
                } else {
                    output += '<div class="error">‚ùå GameState not available</div>';
                }
            } catch (error) {
                output += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            results.innerHTML = output;
        }

        function setupTestPopulation() {
            const results = document.getElementById('population-results');
            let output = '<h3>Population Setup Results:</h3>';
            
            try {
                if (testGameState && testGameState.populationManager) {
                    // Clear existing population
                    testGameState.populationManager.population = [];
                    
                    // Add villagers with specific ages for death testing
                    const testAges = [25, 45, 65, 85, 120, 150, 180, 190, 195, 197, 197];
                    testAges.forEach((age, index) => {
                        testGameState.populationManager.addInhabitant({
                            name: `Test Villager ${index + 1}`,
                            age: age,
                            gender: index % 2 === 0 ? 'male' : 'female',
                            role: 'peasant',
                            status: 'idle'
                        });
                    });
                    
                    testGameState.population = testGameState.populationManager.getAll().length;
                    
                    output += `<div class="success">‚úÖ Added ${testAges.length} test villagers</div>`;
                    output += `<div>Population breakdown by age: ${testAges.join(', ')}</div>`;
                    
                } else {
                    output += '<div class="error">‚ùå PopulationManager not available</div>';
                }
            } catch (error) {
                output += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            results.innerHTML = output;
        }

        function testPopulationDisplay() {
            const results = document.getElementById('population-results');
            let output = results.innerHTML + '<h3>Population Display Test:</h3>';
            
            try {
                if (testGameState && testGameState.populationManager) {
                    // Calculate death estimates
                    const deathData = testGameState.populationManager.calculateExpectedDeaths('daily');
                    const weeklyDeaths = deathData.expectedDeaths * 7;
                    
                    // Calculate growth and net change
                    testGameState.calculateExpectedGrowthRate();
                    const weeklyGrowth = testGameState.expectedGrowthRate;
                    const netChange = weeklyGrowth - weeklyDeaths;
                    
                    output += `<div class="production-display">
                        <h4>Population Analytics:</h4>
                        <div class="stat-row"><span>Current Population:</span><span>${testGameState.population}</span></div>
                        <div class="stat-row"><span>Weekly Growth:</span><span>+${weeklyGrowth.toFixed(2)}</span></div>
                        <div class="stat-row"><span>Expected Deaths:</span><span>${weeklyDeaths.toFixed(1)}/week</span></div>
                        <div class="stat-row"><span>Net Change:</span><span>${netChange >= 0 ? '+' : ''}${netChange.toFixed(2)}/week</span></div>
                    </div>`;
                    
                    // Show death risk breakdown
                    output += `<div class="production-display">
                        <h4>Death Risk Groups:</h4>`;
                    Object.values(deathData.ageGroups).forEach(group => {
                        if (group.count > 0) {
                            output += `<div class="stat-row"><span>${group.name}:</span><span>${group.count} villagers</span></div>`;
                        }
                    });
                    output += `</div>`;
                    
                    output += '<div class="success">‚úÖ Population display calculations working</div>';
                    
                } else {
                    output += '<div class="error">‚ùå PopulationManager not available</div>';
                }
            } catch (error) {
                output += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            results.innerHTML = output;
        }

        function testExplorationAchievement() {
            const results = document.getElementById('exploration-results');
            let output = '<h3>Exploration Achievement Test:</h3>';
            
            try {
                if (testGameState && testGameState.achievements) {
                    // Check if achievement exists
                    const achievement = testGameState.achievements.achievements['first_exploration'];
                    if (achievement) {
                        output += `<div class="success">‚úÖ Achievement exists: ${achievement.title}</div>`;
                        output += `<div>Description: ${achievement.description}</div>`;
                        output += `<div>Icon: ${achievement.icon}</div>`;
                        output += `<div>Reward: ${JSON.stringify(achievement.reward)}</div>`;
                        output += `<div>Unlocked: ${achievement.unlocked ? 'Yes' : 'No'}</div>`;
                        
                        // Test triggering the achievement
                        if (!achievement.unlocked) {
                            testGameState.achievements.triggerTileExplored();
                            output += `<div class="success">‚úÖ Achievement triggered</div>`;
                        } else {
                            output += `<div class="warning">‚ö†Ô∏è Achievement already unlocked</div>`;
                        }
                        
                    } else {
                        output += `<div class="error">‚ùå Achievement 'first_exploration' not found</div>`;
                    }
                } else {
                    output += `<div class="error">‚ùå Achievement system not available</div>`;
                }
            } catch (error) {
                output += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            results.innerHTML = output;
        }

        function checkMetalReward() {
            const results = document.getElementById('exploration-results');
            let output = results.innerHTML + '<h3>Metal Reward Check:</h3>';
            
            try {
                if (testGameState) {
                    const metalBefore = testGameState.resources.metal;
                    output += `<div>Metal before: ${metalBefore}</div>`;
                    
                    // Check if exploration achievement is unlocked
                    const achievement = testGameState.achievements.achievements['first_exploration'];
                    if (achievement && achievement.unlocked) {
                        const metalAfter = testGameState.resources.metal;
                        output += `<div>Metal after: ${metalAfter}</div>`;
                        output += `<div class="success">‚úÖ Metal reward: +${metalAfter - metalBefore}</div>`;
                    } else {
                        output += `<div class="warning">‚ö†Ô∏è Achievement not unlocked yet</div>`;
                    }
                    
                } else {
                    output += `<div class="error">‚ùå GameState not available</div>`;
                }
            } catch (error) {
                output += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            results.innerHTML = output;
        }

        function testBlacksmithBuilding() {
            const results = document.getElementById('blacksmith-results');
            let output = '<h3>Blacksmith Building Test:</h3>';
            
            try {
                // Test building data
                if (GameData.buildingCosts.blacksmith) {
                    output += `<div class="success">‚úÖ Blacksmith costs: ${JSON.stringify(GameData.buildingCosts.blacksmith)}</div>`;
                } else {
                    output += `<div class="error">‚ùå Blacksmith costs not found</div>`;
                }
                
                if (GameData.buildingProduction.blacksmith) {
                    output += `<div class="success">‚úÖ Blacksmith production: ${JSON.stringify(GameData.buildingProduction.blacksmith)}</div>`;
                } else {
                    output += `<div class="error">‚ùå Blacksmith production not found</div>`;
                }
                
                // Test if metal production works
                if (testGameState) {
                    testGameState.buildings = [
                        { id: 'blacksmith1', type: 'blacksmith', x: 100, y: 100, level: 1 }
                    ];
                    
                    const production = testGameState.calculateDailyProduction();
                    output += `<div class="success">‚úÖ Blacksmith metal production: ${production.metal}/day</div>`;
                    
                    // Test starting metal (should be 0)
                    output += `<div>Starting metal: ${testGameState.resources.metal}</div>`;
                    
                    // Test if quarry produces metal
                    testGameState.buildings = [
                        { id: 'quarry1', type: 'quarry', x: 100, y: 100, level: 1 }
                    ];
                    const quarryProduction = testGameState.calculateDailyProduction();
                    output += `<div class="success">‚úÖ Quarry metal production: ${quarryProduction.metal}/day</div>`;
                }
                
            } catch (error) {
                output += `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
            
            results.innerHTML = output;
        }
    </script>
</body>
</html>
