<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle: Dynasty Builder</title>
    <link rel="stylesheet" href="game.css">
    <link rel="stylesheet" href="progress-icons.css">
    
    <!-- Game Scripts -->
    <script src="../src/gameData.js"></script>
    <script src="../src/wikiData.js"></script>
    <script src="../src/systems/core/eventBus.js"></script>
    <script src="../src/skillSystem.js"></script>
    <script src="../src/populationManager.js"></script>
    <script src="../src/gameState.js"></script>
    <script src="../src/utils/errorRecovery.js"></script>
    <script src="../src/modalSystem.js"></script>
    <script src="../src/messageHistory.js"></script>
    <script src="../src/achievements.js"></script>
    <script src="../src/unlockSystem.js"></script>
    <script src="../src/tutorial.js"></script>
    <script src="../src/royalFamily.js"></script>
    <script src="../src/buildingEffects.js"></script>
    <script src="../src/buildingTutorial.js"></script>
    <script src="../src/constructionManager.js"></script>
    <script src="../src/inventoryManager.js"></script>
    <script src="../src/expeditionInventory.js"></script>
    <script src="../src/village.js"></script>
    <script src="../src/throne.js"></script>
    <script src="../src/battle.js"></script>
    <script src="../src/quest.js"></script>
    <script src="../src/quests.js"></script>
    <script src="../src/monarch.js"></script>
    <script src="../src/uiPopups.js"></script>
    <script src="../src/eventBusIntegrations.js"></script>
    <script src="../src/worldManager.js"></script>
    <script src="../src/statsIntegration.js"></script>
    <script src="../src/app.js"></script>
    <script src="../src/main.js"></script>
</head>
<body>
    <!-- Popup panels for top-right buttons -->


    <!-- Tutorial Highlight Overlay -->
    <div id="tutorial-highlight-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999;">
        <div id="tutorial-pointer" style="display: none; position: absolute; color: #f39c12; font-size: 30px; animation: bounce 1s infinite;">
            👆
        </div>
    </div>

    <!-- Notification overlay and container for tutorial/milestone notifications -->
    <div id="notification-overlay" style="display:none;"></div>
    <div id="notification-container" style="display:flex;"></div>

    <!-- Game Container -->
    <div id="game-container">
        <!-- Navigation -->
        <nav id="view-navigation">
            <!-- All navigation elements in one flexible container -->
            <div class="nav-container">
                <!-- View buttons -->
                <div class="nav-section nav-left">
                    <button class="nav-btn active" data-view="village">Village</button>
                    <button class="nav-btn locked" data-view="world">World</button>
                    <button class="nav-btn locked" data-view="monarch">Monarch</button>
                    <button class="nav-btn locked" data-view="throne">Throne</button>
                </div>
                
                <!-- Time controls -->
                <div class="nav-section nav-center" id="global-time-controls">
                    <div class="current-day-nav">
                        <div class="season-info">
                            <span id="current-season-nav">Spring</span>
                            <span id="current-season-day">Day 1</span>
                        </div>
                        <div class="total-day-info">
                            <span>Total:</span>
                            <span id="current-day-number-nav">Day 1</span>
                        </div>
                    </div>
                    <button id="end-day-btn-nav" class="end-day-button time-btn">End Day</button>
                    <button id="auto-play-btn-nav" class="auto-play-button time-btn">
                        <span id="auto-play-icon-nav">▶️</span>
                        <span id="auto-play-text-nav">Play</span>
                    </button>
                    <button id="speed-2x-btn-nav" class="time-btn">2x</button>
                    <button id="speed-4x-btn-nav" class="time-btn">4x</button>
                </div>
                
                <!-- Icon buttons -->
                <div class="nav-section nav-right" id="top-right-icons">
                    <button id="sound-btn" class="icon-btn" title="Sound">
                        <span>🔊</span>
                    </button>
                    <button id="message-history-btn" class="icon-btn" title="Message History" style="position: relative;">
                        <span>📜<span style="position: absolute; top: -5px; right: -5px; 
                            background: #e74c3c; color: white; border-radius: 50%; width: 18px; height: 18px; 
                            font-size: 10px; display: flex; align-items: center; justify-content: center;">
                            9+</span></span>
                    </button>
                    <button id="quest-btn" class="icon-btn" title="Expeditions & Quests">
                        <span>🗺️</span>
                    </button>
                    <button id="wiki-btn" class="icon-btn" title="Game Wiki & Documentation">
                        <span>📖</span>
                    </button>
                    <button id="settings-btn" class="icon-btn" title="Settings">
                        <span>⚙️</span>
                    </button>
                    <button id="achievements-btn" class="icon-btn achievements-incomplete" title="Achievements">
                        <span id="achievements-icon">🏆</span>
                    </button>
                    <button id="inventory-btn" class="icon-btn" title="Inventory" onclick="
                        console.log('=== INVENTORY BUTTON CLICKED ===');
                        try {
                            console.log('window.villageManager:', typeof window.villageManager);
                            console.log('window.inventoryManager:', typeof window.inventoryManager);
                            console.log('window.gameState:', typeof window.gameState);
                            
                            // Try method 1: villageManager
                            if (window.villageManager && window.villageManager.showInventoryModal) {
                                console.log('Trying villageManager.showInventoryModal...');
                                window.villageManager.showInventoryModal();
                                return;
                            }
                            
                            // Try method 2: check if systems need initialization
                            console.log('VillageManager method not available, checking initialization...');
                            if (window.gameState && !window.inventoryManager) {
                                console.log('Attempting to initialize inventory...');
                                if (window.gameState.initializeInventory) {
                                    window.gameState.initializeInventory();
                                }
                                if (window.gameState.inventory) {
                                    window.inventoryManager = window.gameState.inventory;
                                    console.log('Inventory manager initialized and exposed');
                                }
                            }
                            
                            // Try method 3: manual modal
                            if (window.modalSystem) {
                                console.log('Falling back to manual modal...');
                                window.modalSystem.showModal({
                                    id: 'inventory-fallback',
                                    title: 'Inventory System',
                                    content: '<p>Inventory system is initializing...</p><p>Please try again in a moment.</p>',
                                    modalType: 'inventory-fallback'
                                });
                                return;
                            }
                            
                            alert('Inventory system not ready. Check console for details.');
                            
                        } catch (error) {
                            console.error('Inventory button error:', error);
                            alert('Error opening inventory: ' + error.message);
                        }
                    ">
                        <span>🎒</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Game Content -->
        <div id="game-content">
            <!-- Village View -->
                        <!-- Village View -->
            <div id="village-view" class="game-view active">
                                <div class="village-header">
                    <h2>🏘️ Your Village</h2>
                    <div class="resource-panel">
                        <span>💰 Gold: <span id="gold-count"></span></span>
                        <span>🌾 Food: <span id="food-count"></span></span>
                        <span>🌲 Wood: <span id="wood-count"></span></span>
                        <span>🪨 Stone: <span id="stone-count"></span></span>
                        <span>🪙 Metal: <span id="metal-count"></span></span>
                        <span>⚙️ Production: <span id="production-count"></span></span>
                        <span>👥 Population: <span id="population-count"></span>/<span id="population-cap"></span></span>
                        <span>🌸 Season: <span id="season-count"></span></span>
                    </div>
                </div>

                <!-- Objective Bar -->
                <div class="objective-bar">
                    <div class="objective-info">
                        <div class="objective-container">
                            <span class="objective-status" id="objective-status">No Task Selected...</span>
                        </div>
                    </div>
                </div>

                <div class="village-content">
                    <!-- Village Grid (Left Panel) -->
                    <div class="village-grid-panel">
                        <div id="village-grid" class="village-grid">
                            <!-- Generated by village.js -->
                        </div>
                    </div>
                    
                    <!-- Management Panel (Right Panel) -->
                    <div class="management-panel">
                        <!-- Panel Navigation -->
                        <div class="panel-nav">
                            <button class="panel-nav-btn active" data-panel="manager">👥 Village Manager</button>
                            <button class="panel-nav-btn" data-panel="buildings">🏗️ Buildings</button>
                            <button class="panel-nav-btn" data-panel="production">📊 Production</button>
                        </div>
                        
                        <!-- Village Manager Tab (Default) -->
                        <div class="panel-tab active" id="manager-tab">
                            <div class="manager-section">
                                <h4>👥 Population</h4>
                                <div class="population-info">
                                    <div class="population-stat">
                                        <span>Current: <span id="manager-population">0</span></span>
                                    </div>
                                    <div class="population-stat">
                                        <span>Capacity: <span id="manager-population-cap">0</span></span>
                                    </div>
                                    <div class="population-stat">
                                        <span>Weekly Growth: <span id="population-growth-rate">+0</span></span>
                                    </div>
                                    <div class="population-stat">
                                        <span>Expected Deaths: <span id="population-death-rate">0</span>/week</span>
                                    </div>
                                    <div class="population-stat">
                                        <span>Net Change: <span id="population-net-change">+0</span>/week</span>
                                    </div>
                                </div>
                                <div class="population-actions">
                                    <button id="population-view-btn" class="population-view-button">👥 View Population</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Buildings Tab -->
                        <div class="panel-tab" id="buildings-tab">
                            <div class="building-grid">
                                <div class="building-category">
                                    <h4>🏛️ Essential Buildings</h4>
                                    <div class="building-row" id="essential-buildings">
                                        <!-- Basic buildings needed to start -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>🏭 Production Buildings</h4>
                                    <div class="building-row" id="production-buildings">
                                        <!-- Resource gathering and processing -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>🔧 Craft & Trade Buildings</h4>
                                    <div class="building-row" id="craft-buildings">
                                        <!-- Workshops, blacksmiths, markets -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>⚔️ Military Buildings</h4>
                                    <div class="building-row" id="military-buildings">
                                        <!-- Defense and training -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>👑 Royal Buildings</h4>
                                    <div class="building-row" id="royal-buildings">
                                        <!-- Dynasty and prestige -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>📚 Knowledge Buildings</h4>
                                    <div class="building-row" id="knowledge-buildings">
                                        <!-- Research and learning -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>🔮 Advanced Buildings</h4>
                                    <div class="building-row" id="advanced-buildings">
                                        <!-- Late game and special -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Production Tab -->
                        <div class="panel-tab" id="production-tab">
                            <div class="manager-section">
                                <h4>📊 Daily Production</h4>
                                <div class="production-table">
                                    <div class="production-header">
                                        <div class="column-header">Resource</div>
                                        <div class="column-header">Gain</div>
                                        <div class="column-header">Loss</div>
                                        <div class="column-header">Net</div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">🌾</span>
                                            <span class="resource-name">Food</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-food-production">0</span></div>
                                        <div class="loss-cell">-<span id="daily-food-consumption">0</span></div>
                                        <div class="net-cell"><span id="daily-food-net">0</span></div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">🪵</span>
                                            <span class="resource-name">Wood</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-wood-production">0</span></div>
                                        <div class="loss-cell">-<span id="daily-wood-consumption">0</span></div>
                                        <div class="net-cell"><span id="daily-wood-net">0</span></div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">🗿</span>
                                            <span class="resource-name">Stone</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-stone-production">0</span></div>
                                        <div class="loss-cell">-<span id="daily-stone-consumption">0</span></div>
                                        <div class="net-cell"><span id="daily-stone-net">0</span></div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">⚒️</span>
                                            <span class="resource-name">Metal</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-metal-production">0</span></div>
                                        <div class="loss-cell">-<span id="daily-metal-consumption">0</span></div>
                                        <div class="net-cell"><span id="daily-metal-net">0</span></div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">⚙️</span>
                                            <span class="resource-name">Production</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-production-gain">0</span></div>
                                        <div class="loss-cell">-<span id="daily-production-consumption">0</span></div>
                                        <div class="net-cell"><span id="daily-production-net">0</span></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="manager-section">
                                <h4>⚔️ Crafting Queue</h4>
                                <div class="crafting-options">
                                    <div class="craft-item">
                                        <span class="craft-icon">⚔️</span>
                                        <span class="craft-name">Weapon</span>
                                        <span class="craft-cost">5⚙️ 2🪙</span>
                                        <button class="craft-btn" onclick="craftItem('weapon')">Craft</button>
                                    </div>
                                    <div class="craft-item">
                                        <span class="craft-icon">🔨</span>
                                        <span class="craft-name">Tool</span>
                                        <span class="craft-cost">3⚙️ 1🪙</span>
                                        <button class="craft-btn" onclick="craftItem('tool')">Craft</button>
                                    </div>
                                    <div class="craft-item">
                                        <span class="craft-icon">🛡️</span>
                                        <span class="craft-name">Armor</span>
                                        <span class="craft-cost">8⚙️ 3🪙</span>
                                        <button class="craft-btn" onclick="craftItem('armor')">Craft</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

    <style>
        .time-controls .time-btn {
            background: #222;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 5px;
            font-weight: 500;
            margin: 0;
            box-shadow: none;
            cursor: pointer;
            transition: background 0.15s, color 0.15s, border 0.15s;
            outline: none;
            letter-spacing: 0.2px;
            position: relative;
            min-width: 36px;
            padding: 6px 8px;
            font-size: 0.95em;
        }
        .time-controls .time-btn.selected, .time-controls .time-btn:active {
            background: #292f36;
            color: #fff;
            border-color: #444;
        }
        .time-controls .time-btn:hover {
            background: #292f36;
            color: #fff;
            border-color: #444;
        }

        /* Navigation Layout */
        #view-navigation {
            width: 100%;
            padding: 0 1rem 1rem 1rem;
        }

        .nav-container {
            display: flex;
            align-items: center;
            width: 100%;
            min-height: 40px;
            gap: 1rem;
            position: relative;
        }

        .nav-section {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-left {
            /* View buttons stay on left */
            flex: 0 0 auto;
            order: 1;
        }

        .nav-center {
            /* Time controls absolutely centered */
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1;
        }

        .nav-right {
            /* Icons on right */
            flex: 0 0 auto;
            order: 3;
            margin-left: auto;
        }

        /* Responsive behavior to prevent overlaps */
        @media (max-width: 1200px) {
            .nav-container {
                gap: 0.5rem;
            }
            .nav-section {
                gap: 4px;
            }
            
            /* On smaller screens, fall back to flex layout */
            .nav-center {
                position: static;
                transform: none;
                flex: 1 1 auto;
                justify-content: center;
                order: 2;
            }
            
            .nav-container {
                justify-content: space-between;
            }
        }

        @media (max-width: 900px) {
            .nav-container {
                gap: 0.25rem;
            }
            .nav-section {
                gap: 2px;
            }
            
            /* Even smaller buttons on very small screens */
            .time-controls-nav .time-btn {
                padding: 4px 8px;
                min-width: 35px;
                height: 28px;
                font-size: 0.8em;
            }
            
            #view-navigation .icon-btn {
                width: 32px;
                height: 28px;
                padding: 4px 6px;
            }
        }

        /* Navigation Time Controls Styling */
        .time-controls-nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Top Right Icons in Navigation */
        #view-navigation #top-right-icons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #view-navigation .icon-btn {
            background: #34495e;
            color: #ecf0f1;
            border: 1px solid #2c3e50;
            border-radius: 4px;
            padding: 6px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #view-navigation .icon-btn:hover {
            background: #1abc9c;
            color: #fff;
            border-color: #16a085;
            transform: translateY(-1px);
        }

        #view-navigation .icon-btn.achievements-incomplete {
            background: #e74c3c;
            border-color: #c0392b;
        }

        #view-navigation .icon-btn.achievements-incomplete:hover {
            background: #c0392b;
            border-color: #a93226;
        }

        .current-day-nav {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-size: 0.75em;
            color: #e2e8f0;
            margin-right: 16px;
            min-width: 100px;
            background: linear-gradient(145deg, #2d3748 0%, #1a202c 100%);
            border: 2px solid #4a5568;
            border-radius: 6px;
            padding: 6px 10px;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
            gap: 2px;
            height: 36px;
            justify-content: center;
        }

        .current-day-nav::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
        }

        .season-info, .total-day-info {
            display: flex;
            align-items: center;
            line-height: 1;
            gap: 4px;
        }

        .season-info span:first-child {
            color: #f7fafc;
            font-weight: 700;
            font-size: 1.1em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .season-info span:last-child {
            color: #38b2ac;
            font-weight: 600;
            font-size: 1em;
            text-shadow: 0 0 4px rgba(56, 178, 172, 0.4);
        }

        .total-day-info span:first-child {
            color: #a0aec0;
            font-weight: 600;
            font-size: 0.9em;
        }

        .total-day-info span:last-child {
            color: #edf2f7;
            font-weight: 700;
            font-size: 1em;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .time-controls-nav .time-btn {
            background: linear-gradient(145deg, #4a5568 0%, #2d3748 50%, #1a202c 100%);
            color: #e2e8f0;
            border: 2px solid #4a5568;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            outline: none;
            font-size: 0.8em;
            padding: 8px 12px;
            min-width: 50px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.2);
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
            position: relative;
            overflow: hidden;
        }

        .time-controls-nav .time-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .time-controls-nav .time-btn:hover {
            background: linear-gradient(145deg, #38b2ac 0%, #319795 50%, #2c7a7b 100%);
            color: #fff;
            border-color: #38b2ac;
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 4px 8px rgba(0,0,0,0.4),
                0 0 12px rgba(56, 178, 172, 0.3),
                inset 0 1px 0 rgba(255,255,255,0.2),
                inset 0 -1px 0 rgba(0,0,0,0.1);
        }

        .time-controls-nav .time-btn:hover::before {
            left: 100%;
        }

        .time-controls-nav .time-btn.selected,
        .time-controls-nav .time-btn:active {
            background: linear-gradient(145deg, #e53e3e 0%, #c53030 50%, #9c2626 100%);
            color: #fff;
            border-color: #e53e3e;
            transform: translateY(-1px) scale(0.98);
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.4),
                0 0 15px rgba(229, 62, 62, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.1),
                inset 0 -1px 0 rgba(0,0,0,0.3);
        }

        .time-controls-nav .auto-play-button {
            min-width: 75px;
            gap: 5px;
        }

        .time-controls-nav .end-day-button {
            min-width: 80px;
        }

        /* Add pulsing animation for active auto-play */
        .time-controls-nav .auto-play-button.auto-play-active {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 
                    0 4px 6px rgba(0,0,0,0.3),
                    0 0 15px rgba(56, 178, 172, 0.3),
                    inset 0 1px 0 rgba(255,255,255,0.1),
                    inset 0 -1px 0 rgba(0,0,0,0.2);
            }
            50% {
                box-shadow: 
                    0 6px 12px rgba(0,0,0,0.4),
                    0 0 25px rgba(56, 178, 172, 0.6),
                    inset 0 1px 0 rgba(255,255,255,0.2),
                    inset 0 -1px 0 rgba(0,0,0,0.1);
            }
        }
    </style>

    <!-- New 2-Panel Layout CSS -->
    <style>
        /* Village Content Layout - 2 Panel System */
        .village-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            width: 100%;
            height: calc(100vh - 120px);
            overflow: hidden;
        }

        /* Village Grid Panel (Left) */
        .village-grid-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1rem;
            overflow: auto;
        }

        .village-grid {
            width: 100%;
            height: 100%;
        }

        /* Management Panel (Right) */
        .management-panel {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Panel Navigation */
        .panel-nav {
            display: flex;
            background: #222;
            border-bottom: 1px solid #333;
            border-radius: 8px 8px 0 0;
        }

        .panel-nav-btn {
            flex: 1;
            background: #222;
            color: #e0e0e0;
            border: none;
            padding: 12px 8px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
        }

        .panel-nav-btn:hover {
            background: #2a2a2a;
            color: #fff;
        }

        .panel-nav-btn.active {
            background: #2a2a2a;
            color: #fff;
            border-bottom-color: #4CAF50;
        }

        .panel-nav-btn:first-child {
            border-radius: 8px 0 0 0;
        }

        .panel-nav-btn:last-child {
            border-radius: 0 8px 0 0;
        }

        /* Panel Tabs */
        .panel-tab {
            display: none;
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .panel-tab.active {
            display: block;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .stat-item {
            background: #222;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #333;
        }

        .stat-label {
            display: block;
            font-size: 0.8em;
            color: #bbb;
            margin-bottom: 2px;
        }

        .stat-value {
            display: block;
            font-size: 1.1em;
            font-weight: bold;
            color: #4CAF50;
        }

        /* Building Grid */
        .building-grid {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .building-category {
            background: #222;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 12px;
        }

        .building-category h4 {
            margin: 0 0 8px 0;
            color: #e0e0e0;
            font-size: 0.9em;
            border-bottom: 1px solid #333;
            padding-bottom: 4px;
        }

        .building-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 8px;
        }

        /* Building Buttons */
        .building-btn {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #e0e0e0;
            text-align: center;
        }

        .building-btn:hover {
            background: #2a2a2a;
            border-color: #4CAF50;
            transform: translateY(-1px);
        }

        .building-icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        .building-name {
            font-size: 0.8em;
            font-weight: 600;
            margin-bottom: 2px;
            color: #fff;
        }

        .building-cost {
            font-size: 0.7em;
            color: #bbb;
        }

        /* Enhanced Speed Controls */
        .time-controls .time-btn {
            background: linear-gradient(135deg, #2a2a2a 0%, #1a1a1a 100%) !important;
            border: 2px solid #333 !important;
            color: #e0e0e0 !important;
            border-radius: 8px !important;
            padding: 8px 12px !important;
            font-weight: 600 !important;
            cursor: pointer;
            transition: all 0.3s ease !important;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3) !important;
        }

        .time-controls .time-btn:hover {
            background: linear-gradient(135deg, #3a3a3a 0%, #2a2a2a 100%) !important;
            border-color: #4CAF50 !important;
            color: #fff !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.4) !important;
        }

        .time-controls .time-btn.selected,
        .time-controls .time-btn:active {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%) !important;
            border-color: #4CAF50 !important;
            color: #fff !important;
            transform: translateY(0) !important;
            box-shadow: 0 2px 4px rgba(76, 175, 80, 0.3) !important;
        }

        .time-controls .time-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .time-controls .time-btn:hover::before {
            left: 100%;
        }

        /* Modal Stats Styling */
        .stats-grid-modal {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .stat-item-modal {
            background: #333;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .stat-label-modal {
            font-size: 0.85em;
            color: #bbb;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .stat-value-modal {
            font-size: 1.3em;
            font-weight: bold;
            color: #4CAF50;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .village-content {
                grid-template-columns: 1.5fr 1fr;
            }
        }

        @media (max-width: 900px) {
            .village-content {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr auto;
                height: auto;
            }
            
            .management-panel {
                max-height: 400px;
            }
        }
    </style>
<script>
// Time control speed buttons logic
document.addEventListener('DOMContentLoaded', function() {
    // Navigation time controls (new location)
    const autoPlayBtnNav = document.getElementById('auto-play-btn-nav');
    const speed2xBtnNav = document.getElementById('speed-2x-btn-nav');
    const speed4xBtnNav = document.getElementById('speed-4x-btn-nav');
    const endDayBtnNav = document.getElementById('end-day-btn-nav');
    
    // Initialize autoPlaySpeed if not set
    if (window.gameState && !window.gameState.autoPlaySpeed) {
        window.gameState.autoPlaySpeed = 20000; // Default 20 seconds
    }
    
    let lastSpeed = 20000;
    function setSpeed(ms, btn) {
        if (window.gameState) {
            window.gameState.autoPlaySpeed = ms;
            if (window.gameState.autoPlayActive) {
                window.gameState.stopAutoPlay();
                window.gameState.startAutoPlay();
            }
        }
        // Visual feedback
        [autoPlayBtnNav, speed2xBtnNav, speed4xBtnNav].forEach(b => b && b.classList.remove('selected'));
        if (btn) btn.classList.add('selected');
    }
    
    // End day button
    if (endDayBtnNav) {
        endDayBtnNav.addEventListener('click', function() {
            if (window.gameState) {
                window.gameState.endDay();
            }
            // Button animation
            endDayBtnNav.style.transform = 'scale(0.95)';
            setTimeout(() => {
                endDayBtnNav.style.transform = '';
            }, 100);
        });
    }
    
    // Auto-play toggle button
    if (autoPlayBtnNav) {
        autoPlayBtnNav.addEventListener('click', function() {
            if (window.gameState) {
                window.gameState.toggleAutoPlay();
            }
        });
    }
    
    // Speed buttons
    if (speed2xBtnNav) {
        speed2xBtnNav.addEventListener('click', function() {
            setSpeed(10000, speed2xBtnNav); // 2x speed
        });
    }
    if (speed4xBtnNav) {
        speed4xBtnNav.addEventListener('click', function() {
            setSpeed(5000, speed4xBtnNav); // 4x speed
        });
    }
    
    // Update navigation time controls when gameState is ready
    function updateNavigationTimeControls() {
        if (window.gameState) {
            // Update day/season display
            const seasonNavElement = document.getElementById('current-season-nav');
            const dayNavElement = document.getElementById('current-day-number-nav');
            const seasonDayElement = document.getElementById('current-season-day');
            
            if (seasonNavElement && window.gameState.season) {
                seasonNavElement.textContent = window.gameState.season;
            }
            
            // Calculate total days played across all seasons
            if (dayNavElement && window.gameState.currentDay && window.gameState.currentSeasonIndex !== undefined && window.gameState.daysInSeason) {
                const totalDays = (window.gameState.currentSeasonIndex * window.gameState.daysInSeason) + window.gameState.currentDay;
                dayNavElement.textContent = `Day ${totalDays}`;
            }
            
            // Show current day within the season
            if (seasonDayElement && window.gameState.currentDay) {
                seasonDayElement.textContent = `Day ${window.gameState.currentDay}`;
            }
            
            // Update auto-play button state
            if (window.gameState.updateAutoPlayUI) {
                window.gameState.updateAutoPlayUI();
            }
        } else {
            // Retry if gameState not ready yet
            setTimeout(updateNavigationTimeControls, 200);
        }
    }
    
    // Call update function after a short delay to ensure gameState is loaded
    setTimeout(updateNavigationTimeControls, 500);
    
    // Set up periodic updates to keep navigation in sync
    setInterval(updateNavigationTimeControls, 1000);
    
    // Listen for day change events if eventBus is available
    if (window.eventBus) {
        window.eventBus.on && window.eventBus.on('day-ended', updateNavigationTimeControls);
        window.eventBus.on && window.eventBus.on('resources-updated', updateNavigationTimeControls);
    }
});
</script>

<!-- Panel Switching JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Panel switching functionality
    const panelNavBtns = document.querySelectorAll('.panel-nav-btn');
    const panelTabs = document.querySelectorAll('.panel-tab');
    
    panelNavBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const targetPanel = this.dataset.panel;
            
            // Remove active class from all buttons and tabs
            panelNavBtns.forEach(b => b.classList.remove('active'));
            panelTabs.forEach(t => t.classList.remove('active'));
            
            // Add active class to clicked button and corresponding tab
            this.classList.add('active');
            const targetTab = document.getElementById(targetPanel + '-tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Update building tabs when buildings panel is opened
            if (targetPanel === 'buildings') {
                updateBuildingGrid();
            }
        });
    });
    
    // Update stats display
    function updateStatsDisplay() {
        if (window.gameState && window.gameState.stats) {
            const stats = window.gameState.stats;
            
            // Update stat values if elements exist
            const totalDaysEl = document.getElementById('stat-total-days');
            if (totalDaysEl) totalDaysEl.textContent = stats.totalDaysElapsed || 1;
            
            const peakPopEl = document.getElementById('stat-peak-population');
            if (peakPopEl) peakPopEl.textContent = stats.peakPopulation || 1;
            
            const buildingsEl = document.getElementById('stat-buildings-built');
            if (buildingsEl) buildingsEl.textContent = stats.buildingsBuilt || 0;
            
            const seasonsEl = document.getElementById('stat-seasons-passed');
            if (seasonsEl) seasonsEl.textContent = Math.floor((stats.totalDaysElapsed || 1) / 28) || 0;
        }
    }
    
    // Update building grid in buildings tab
    function updateBuildingGrid() {
        const essentialContainer = document.getElementById('essential-buildings');
        const housingContainer = document.getElementById('housing-buildings');
        const militaryContainer = document.getElementById('military-buildings');
        
        if (!essentialContainer || !housingContainer || !militaryContainer) return;
        
        // Clear existing content
        essentialContainer.innerHTML = '';
        housingContainer.innerHTML = '';
        militaryContainer.innerHTML = '';
        
        // Get building data from global scope
        if (typeof buildingData !== 'undefined') {
            // Essential buildings
            const essentialBuildings = ['farm', 'house', 'well'];
            essentialBuildings.forEach(buildingId => {
                if (buildingData[buildingId]) {
                    essentialContainer.appendChild(createBuildingButton(buildingId, buildingData[buildingId]));
                }
            });
            
            // Housing & Production buildings
            const housingBuildings = ['mill', 'workshop', 'market', 'inn'];
            housingBuildings.forEach(buildingId => {
                if (buildingData[buildingId]) {
                    housingContainer.appendChild(createBuildingButton(buildingId, buildingData[buildingId]));
                }
            });
            
            // Military & Advanced buildings
            const militaryBuildings = ['barracks', 'blacksmith', 'tower', 'temple'];
            militaryBuildings.forEach(buildingId => {
                if (buildingData[buildingId]) {
                    militaryContainer.appendChild(createBuildingButton(buildingId, buildingData[buildingId]));
                }
            });
        }
    }
    
    // Create building button element
    function createBuildingButton(buildingId, buildingInfo) {
        const button = document.createElement('button');
        button.className = 'building-btn';
        button.innerHTML = `
            <div class="building-icon">${buildingInfo.icon || '🏠'}</div>
            <div class="building-name">${buildingInfo.name || buildingId}</div>
            <div class="building-cost">${formatCost(buildingInfo.cost)}</div>
        `;
        
        button.addEventListener('click', function() {
            if (window.village && typeof window.village.buildBuilding === 'function') {
                window.village.buildBuilding(buildingId);
            }
        });
        
        return button;
    }
    
    // Format cost display
    function formatCost(cost) {
        if (!cost) return '';
        const costParts = [];
        if (cost.food) costParts.push(`${cost.food}🌾`);
        if (cost.wood) costParts.push(`${cost.wood}🪵`);
        if (cost.stone) costParts.push(`${cost.stone}🗿`);
        if (cost.metal) costParts.push(`${cost.metal}⚒️`);
        if (cost.production) costParts.push(`${cost.production}⚙️`);
        return costParts.join(' ');
    }
    
    // Update display on game events
    if (window.eventBus) {
        window.eventBus.on('day-ended', updateStatsDisplay);
        window.eventBus.on('resources-updated', updateStatsDisplay);
        window.eventBus.on('building-built', updateBuildingGrid);
    }
    
    // Initial update
    setTimeout(() => {
        updateStatsDisplay();
        updateBuildingGrid();
    }, 500);
});
</script>
                    </div>
                </div>
            </div>

            <!-- World View -->
            <div id="world-view" class="game-view">
                <!-- WorldManager will populate this dynamically -->
                
                <!-- Battle Modal (hidden by default) -->
                <div id="battle-modal" class="battle-modal" style="display: none;">
                    <div class="battle-modal-content">
                        <div class="battle-header">
                            <h2>⚔️ Battle: <span id="battle-location">Northern Plains</span></h2>
                            <button id="close-battle-modal" class="close-btn">×</button>
                            <div class="weather-terrain-display">
                                <span id="weather-display">🌤️ Clear</span>
                                <span id="terrain-display">🌾 Plains</span>
                            </div>
                        </div>
                        
                        <div class="battle-content">
                            <!-- Battle Viewing Options -->
                            <div class="battle-options">
                                <button id="watch-battle-btn" class="btn primary">�️ Watch Battle</button>
                                <button id="auto-resolve-btn" class="btn">⚡ Auto-Resolve</button>
                                <button id="pause-battle-btn" class="btn" style="display: none;">⏸️ Pause</button>
                            </div>
                            
                            <!-- Battle Field -->
                            <div class="battle-field-container">
                                <div id="battle-field" class="battle-field">
                                    <!-- Battle visualization will be rendered here -->
                                </div>
                                
                                <!-- Battle Controls -->
                                <div class="battle-controls">
                                    <div class="battle-speed-controls">
                                        <button id="speed-1x" class="speed-btn active">1x</button>
                                        <button id="speed-2x" class="speed-btn">2x</button>
                                        <button id="speed-4x" class="speed-btn">4x</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Battle Progress -->
                            <div class="battle-progress">
                                <div class="army-status">
                                    <div class="player-army">
                                        <h4>🛡️ Your Army</h4>
                                        <div id="player-army-units"></div>
                                    </div>
                                    <div class="enemy-army">
                                        <h4>⚔️ Enemy Army</h4>
                                        <div id="enemy-army-units"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Battle Log -->
                            <div class="battle-log-panel">
                                <h3>📜 Battle Log</h3>
                                <div id="battle-log" class="battle-log">
                                    <div class="log-entry">Battle ready to begin...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Monarch View -->
            <div id="monarch-view" class="game-view">
                <div class="locked-view">
                    <h2>👑 Monarch's Court</h2>
                    <p class="lock-message">This feature will be unlocked as you progress through the game.</p>
                </div>
                
                <!-- Unlocked Monarch Content -->
                <div id="monarch-content" class="monarch-content" style="display: none;">
                    <div class="monarch-header">
                        <h2>👑 Royal Court & Dynasty Management</h2>
                        <p>Manage your royal investments, advisors, and dynasty legacy</p>
                    </div>
                    
                    <!-- Royal Investment System -->
                    <div class="monarch-section">
                        <h3>💰 Royal Investments</h3>
                        <div class="investment-categories">
                            <!-- Village Investments -->
                            <div class="investment-category">
                                <h4>🏘️ Village Development</h4>
                                <div class="investment-grid">
                                    <div class="investment-item">
                                        <div class="investment-icon">⚡</div>
                                        <div class="investment-details">
                                            <h5>Production Boost</h5>
                                            <p>+10% efficiency to all buildings</p>
                                            <div class="investment-cost">Cost: 100 💰</div>
                                        </div>
                                        <button class="investment-btn" data-cost="100" data-type="productionBoost">Invest</button>
                                    </div>
                                    
                                    <div class="investment-item">
                                        <div class="investment-icon">🏗️</div>
                                        <div class="investment-details">
                                            <h5>New Building Types</h5>
                                            <p>Unlock advanced buildings</p>
                                            <div class="investment-cost">Cost: 250 💰</div>
                                        </div>
                                        <button class="investment-btn" data-cost="250" data-type="buildingTypes">Invest</button>
                                    </div>
                                    
                                    <div class="investment-item">
                                        <div class="investment-icon">🤖</div>
                                        <div class="investment-details">
                                            <h5>Automation Level Up</h5>
                                            <p>Improve citizen automation</p>
                                            <div class="investment-cost">Cost: 500 💰</div>
                                        </div>
                                        <button class="investment-btn" data-cost="500" data-type="automationLevel">Invest</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Military Investments -->
                            <div class="investment-category">
                                <h4>⚔️ Military Excellence</h4>
                                <div class="investment-grid">
                                    <div class="investment-item">
                                        <div class="investment-icon">🔍</div>
                                        <div class="investment-details">
                                            <h5>Army Scouts</h5>
                                            <p>Improve AI battle decision-making</p>
                                            <div class="investment-cost">Cost: 200 💰</div>
                                        </div>
                                        <button class="investment-btn" data-cost="200" data-type="armyScouts">Invest</button>
                                    </div>
                                    
                                    <div class="investment-item">
                                        <div class="investment-icon">⭐</div>
                                        <div class="investment-details">
                                            <h5>Elite Generals</h5>
                                            <p>Hire better commanders</p>
                                            <div class="investment-cost">Cost: 400 💰</div>
                                        </div>
                                        <button class="investment-btn" data-cost="400" data-type="eliteGenerals">Invest</button>
                                    </div>
                                    
                                    <div class="investment-item">
                                        <div class="investment-icon">🎓</div>
                                        <div class="investment-details">
                                            <h5>Tactical Academy</h5>
                                            <p>Commanders learn faster</p>
                                            <div class="investment-cost">Cost: 800 💰</div>
                                        </div>
                                        <button class="investment-btn" data-cost="800" data-type="tacticalAcademy">Invest</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Legacy Investments -->
                            <div class="investment-category">
                                <h4>🏰 Dynasty Legacy</h4>
                                <div class="investment-grid">
                                    <div class="investment-item">
                                        <div class="investment-icon">🏘️</div>
                                        <div class="investment-details">
                                            <h5>Parallel Villages</h5>
                                            <p>Run multiple villages simultaneously</p>
                                            <div class="investment-cost">Cost: 1000 💰</div>
                                        </div>
                                        <button class="investment-btn" data-cost="1000" data-type="parallelVillages">Invest</button>
                                    </div>
                                    
                                    <div class="investment-item">
                                        <div class="investment-icon">🔄</div>
                                        <div class="investment-details">
                                            <h5>Prestige Automation</h5>
                                            <p>Remember placement orders</p>
                                            <div class="investment-cost">Cost: 2000 💰</div>
                                        </div>
                                        <button class="investment-btn" data-cost="2000" data-type="prestigeAutomation">Invest</button>
                                    </div>
                                    
                                    <div class="investment-item">
                                        <div class="investment-icon">👑</div>
                                        <div class="investment-details">
                                            <h5>Dynasty Progression</h5>
                                            <p>Multi-generational upgrades</p>
                                            <div class="investment-cost">Cost: 5000 💰</div>
                                        </div>
                                        <button class="investment-btn" data-cost="5000" data-type="dynastyProgression">Invest</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Royal Advisors Section -->
                    <div class="monarch-section">
                        <h3>🎭 Royal Advisors</h3>
                        <div id="advisor-panel" class="advisor-panel">
                            <!-- Advisor content will be populated by monarch.js -->
                        </div>
                    </div>
                    
                    <!-- Dynasty Reset Tools -->
                    <div class="monarch-section">
                        <h3>⚰️ Dynasty Management</h3>
                        <div class="dynasty-tools">
                            <div class="dynasty-info">
                                <h4>📊 Current Dynasty Status</h4>
                                <div id="dynasty-stats" class="dynasty-stats">
                                    <!-- Will be populated by monarch.js -->
                                </div>
                            </div>
                            
                            <div class="prestige-actions">
                                <h4>🔄 Dynasty Actions</h4>
                                <button id="calculate-inheritance-btn" class="dynasty-btn">💰 Calculate Inheritance</button>
                                <button id="prestige-reset-btn" class="dynasty-btn danger">⚰️ End Dynasty (Prestige Reset)</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Investment Status Display -->
                    <div class="monarch-section">
                        <h3>📈 Active Investments</h3>
                        <div id="investment-status" class="investment-status">
                            <!-- Will be populated by monarch.js -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Throne View -->
            <div id="throne-view" class="game-view">
                <div class="locked-view">
                    <h2>🏰 The Throne</h2>
                    <p class="lock-message">This feature will be unlocked as you progress through the game.</p>
                </div>
                
                <!-- Unlocked Throne Content -->
                <div id="throne-content" class="throne-content" style="display: none;">
                    <div class="throne-header">
                        <h2>🏰 The Royal Throne</h2>
                        <p>Manage your dynasty, royal family, and ceremonial artifacts</p>
                    </div>
                    
                    <!-- Throne Navigation Tabs -->
                    <div class="throne-tabs">
                        <button class="throne-tab-btn active" data-tab="dynasty">👑 Dynasty</button>
                        <button class="throne-tab-btn" data-tab="merge">✨ Artifacts</button>
                        <button class="throne-tab-btn" data-tab="court">🏛️ Court</button>
                    </div>
                    
                    <!-- Dynasty Tab -->
                    <div id="dynasty-tab" class="throne-tab active">
                        <div class="dynasty-content">
                            <!-- Current Monarch Section -->
                            <div class="dynasty-section">
                                <h3>👑 Current Monarch</h3>
                                <div id="current-monarch" class="monarch-card">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>
                            
                            <!-- Royal Family Tree -->
                            <div class="dynasty-section">
                                <h3>🌳 Royal Family</h3>
                                <div id="royal-family-tree" class="family-tree">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>
                            
                            <!-- Marriage & Heirs -->
                            <div class="dynasty-section">
                                <h3>💒 Marriage & Succession</h3>
                                <div class="dynasty-actions">
                                    <button id="arrange-marriage-btn" class="dynasty-btn">💒 Arrange Marriage</button>
                                    <button id="hire-tutor-btn" class="dynasty-btn">🎓 Hire Tutors</button>
                                    <button id="succession-plan-btn" class="dynasty-btn">📜 Succession Plan</button>
                                </div>
                                <div id="succession-order" class="succession-list">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>
                            
                            <!-- Dynasty Stats -->
                            <div class="dynasty-section">
                                <h3>📊 Dynasty Legacy</h3>
                                <div id="dynasty-stats" class="dynasty-stats">
                                    <!-- Will be populated by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Artifacts Tab -->
                    <div id="merge-tab" class="throne-tab">
                        <div class="throne-merge-content">
                            <div class="merge-header">
                                <h3>✨ Royal Artifacts</h3>
                                <p>Merge ceremonial items to create powerful artifacts</p>
                            </div>
                            
                            <div class="merge-container">
                                <div id="merge-grid" class="merge-grid">
                                    <!-- Throne merge system will populate this -->
                                </div>
                                
                                <div class="merge-info">
                                    <h4>🎁 Active Bonuses</h4>
                                    <div id="active-bonuses">
                                        <p>No bonuses yet - start merging!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Court Tab -->
                    <div id="court-tab" class="throne-tab">
                        <div class="court-content">
                            <h3>🏛️ Royal Court</h3>
                            <p>Manage advisors, nobles, and court affairs</p>
                            <div id="court-affairs" class="court-panel">
                                <!-- Will be populated by JS -->
                                <p style="color: #888; font-style: italic;">Court management coming in future updates...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Enhanced Day Control Buttons */
        .day-controls button.end-day-button, .day-controls button.auto-play-button {
            background: #222;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 7px 16px;
            font-size: 1em;
            font-weight: 500;
            margin: 8px 0 0 0;
            box-shadow: none;
            cursor: pointer;
            transition: background 0.15s, color 0.15s, border 0.15s;
            outline: none;
            letter-spacing: 0.2px;
            position: relative;
        }
        .day-controls button.end-day-button,
        .day-controls button.auto-play-button {
            margin-right: 6px;
        }
        .day-controls button.end-day-button:last-child,
        .day-controls button.auto-play-button:last-child {
            margin-right: 0;
        }
        .day-controls button.end-day-button:hover,
        .day-controls button.auto-play-button:hover {
            background: #292f36;
            color: #fff;
            border-color: #444;
        }
        .day-controls button.end-day-button:active,
        .day-controls button.auto-play-button:active {
            background: #181c20;
            color: #b0b0b0;
            border-color: #222;
        }
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        .tutorial-highlight {
            position: relative;
            box-shadow: 0 0 20px #f39c12 !important;
            border: 3px solid #f39c12 !important;
            background: rgba(243, 156, 18, 0.1) !important;
            z-index: 9998 !important;
        }
        
        .tutorial-highlight::after {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: transparent;
            border: 2px dashed #f39c12;
            border-radius: inherit;
            animation: pulse 2s infinite;
        }

        /* Locked building button styles */
        .build-btn.locked {
            opacity: 0.5;
            background: #555 !important;
            color: #888 !important;
            cursor: not-allowed;
            position: relative;
        }

        .build-btn.locked::before {
            content: '🔒';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 12px;
        }

        .build-btn.locked:hover {
            background: #555 !important;
            transform: none;
        }
        
        @keyframes pulse {
            0% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
            100% {
                opacity: 1;
            }
        }
    </style>

    <style>
        /* Battle Modal Styles */
        .battle-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .battle-modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            width: 95%;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #000;
        }

        .battle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            margin-right: 40px;
            padding: 15px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 10px;
            color: white;
        }

        .weather-terrain-display {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .battle-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .battle-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .battle-field-container,
        .battle-progress,
        .battle-log-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
        }

        .battle-field {
            height: 300px;
            background: #e8f5e8;
            border: 2px solid #27ae60;
            border-radius: 8px;
            position: relative;
            margin-bottom: 15px;
        }

        .battle-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .battle-speed-controls {
            display: flex;
            gap: 5px;
        }

        .speed-btn {
            padding: 5px 12px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .speed-btn.active {
            background: #3498db;
            color: white;
        }

        .army-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .player-army,
        .enemy-army {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #ddd;
        }

        .player-army {
            border-color: #27ae60;
        }

        .enemy-army {
            border-color: #e74c3c;
        }

        .battle-log {
            height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry:nth-child(even) {
            background: #f8f9fa;
        }

        .army-unit-card {
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .army-unit-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .unit-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .unit-type {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .unit-stats {
            font-size: 12px;
            color: #7f8c8d;
        }

        .battle-field {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            border: 3px solid #d35400;
            border-radius: 10px;
            height: 400px;
            position: relative;
            overflow: hidden;
            margin: 15px 0;
        }

        .battle-unit, .battle-enemy {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .battle-unit {
            background: #27ae60;
            color: white;
        }

        .battle-enemy {
            background: #e74c3c;
            color: white;
        }

        .army-actions,
        .battle-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn.primary {
            background: #3498db;
            color: white;
        }

        .btn.primary:hover {
            background: #2980b9;
        }

        .btn:not(.primary) {
            background: #95a5a6;
            color: white;
        }

        .btn:not(.primary):hover {
            background: #7f8c8d;
        }

        .battle-log {
            max-height: 150px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }

        .log-entry {
            padding: 2px 0;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        /* Monarch View Styles */
        .monarch-content {
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 2rem;
            overflow-y: auto;
            height: calc(100vh - 120px);
        }

        .monarch-header {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            border: 2px solid #1abc9c;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
        }

        .monarch-header h2 {
            margin: 0 0 0.5rem 0;
            color: #f1c40f;
            font-size: 2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .monarch-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .monarch-section {
            background: #222;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .monarch-section h3 {
            color: #1abc9c;
            margin: 0 0 1rem 0;
            font-size: 1.4rem;
            border-bottom: 2px solid #333;
            padding-bottom: 0.5rem;
        }

        .investment-categories {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .investment-category {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1rem;
        }

        .investment-category h4 {
            color: #f39c12;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
        }

        .investment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .investment-item {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .investment-item:hover {
            border-color: #1abc9c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 188, 156, 0.3);
        }

        .investment-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            border-radius: 50%;
            border: 2px solid #1abc9c;
            box-shadow: 0 2px 8px rgba(26, 188, 156, 0.2);
        }

        .investment-details {
            flex: 1;
        }

        .investment-details h5 {
            color: #ecf0f1;
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }

        .investment-details p {
            color: #bdc3c7;
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
        }

        .investment-cost {
            color: #f1c40f;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .investment-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(39, 174, 96, 0.3);
        }

        .investment-btn:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }

        .investment-btn:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .advisor-panel {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-radius: 8px;
            padding: 1.5rem;
            border: 2px solid #1abc9c;
        }

        .dynasty-tools {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .dynasty-info, .prestige-actions {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .dynasty-info h4, .prestige-actions h4 {
            color: #e74c3c;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
        }

        .dynasty-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: bold;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
        }

        .dynasty-btn:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .dynasty-btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
        }

        .dynasty-btn.danger:hover {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .investment-status {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .dynasty-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .dynasty-stat {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .dynasty-stat-label {
            color: #bdc3c7;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .dynasty-stat-value {
            color: #f1c40f;
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dynasty-tools {
                grid-template-columns: 1fr;
            }
            
            .investment-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .monarch-content {
                padding: 1rem;
            }
            
            .monarch-header {
                padding: 1rem;
            }
            
            .monarch-header h2 {
                font-size: 1.5rem;
            }
            
            .investment-item {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Inheritance Calculation Modal Styles */
        .dynasty-calculation {
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 1rem;
            border-radius: 8px;
        }

        .inheritance-breakdown {
            margin: 1rem 0;
        }

        .inheritance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
        }

        .inheritance-item:last-child {
            border-bottom: none;
        }

        .inheritance-label {
            color: #bdc3c7;
            font-size: 0.9rem;
        }

        .inheritance-value {
            color: #f1c40f;
            font-weight: bold;
        }

        .inheritance-total {
            background: #2a2a2a;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .inheritance-total .inheritance-label {
            color: #ecf0f1;
            font-size: 1rem;
        }

        .inheritance-total .inheritance-value {
            color: #2ecc71;
            font-size: 1.2rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .battle-content {
                grid-template-columns: 1fr;
            }
            
            .commander-panel,
            .army-panel {
                grid-column: 1;
            }
            
            .battle-field-container,
            .battle-log-panel {
                grid-column: 1;
            }
        }
    </style>
</style>
<script>
// --- View Switching System ---
let worldManager = null;
let currentView = 'village';

function switchView(view) {
    // Hide all game views
    document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active'));
    // Show selected view
    const viewEl = document.getElementById(view + '-view');
    if (viewEl) viewEl.classList.add('active');
    currentView = view;

    // Initialize WorldManager if switching to world view
    if (view === 'world') {
        if (!window.worldManager) {
            if (window.WorldManager && window.gameState && window) {
                window.worldManager = new window.WorldManager(window.gameState, window);
            }
        }
        if (window.worldManager && typeof window.worldManager.init === 'function') {
            window.worldManager.init();
        }
    }
}

// Navigation button event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('#view-navigation .nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (btn.classList.contains('locked')) return;
            const view = btn.getAttribute('data-view');
            switchView(view);
            // Update nav button active state
            document.querySelectorAll('#view-navigation .nav-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        });
    });
});
</script>
</body>
</html>
</script>
<script>
// On hover, check if locked nav button can be unlocked and unlock if requirements are met
document.addEventListener('DOMContentLoaded', function() {
    const navBtns = document.querySelectorAll('#view-navigation .nav-btn');
    navBtns.forEach(btn => {
        btn.addEventListener('mouseenter', function() {
            if (btn.classList.contains('locked')) {
                const view = btn.getAttribute('data-view');
                if (window.unlockSystem && typeof window.unlockSystem.isViewUnlocked === 'function') {
                    // Check if requirements are now met
                    const unlockId = view + '_view';
                    if (window.unlockSystem.checkUnlockConditions && window.unlockSystem.checkUnlockConditions(unlockId)) {
                        // Unlock it
                        window.unlockSystem.unlock(unlockId);
                        // UI will update via eventBus or polling
                    }
                }
            }
        });
    });
});
// Dynamically update resource and season values from gameState and gameData
function updateResourcePanel() {
    if (!window.gameState || !window.GameData) return;
    const resources = window.gameState.resources || {};
    document.getElementById('gold-count').textContent = resources.gold ?? 0;
    document.getElementById('food-count').textContent = resources.food ?? 0;
    document.getElementById('wood-count').textContent = resources.wood ?? 0;
    document.getElementById('stone-count').textContent = resources.stone ?? 0;
    document.getElementById('metal-count').textContent = resources.metal ?? 0;
    document.getElementById('population-count').textContent = window.gameState.population ?? 0;
    // Use cap from GameData if available, else fallback to gameState
    let popCap = (window.GameData.resourceCaps && window.GameData.resourceCaps.population) ? window.GameData.resourceCaps.population : (window.gameState.populationCap ?? 0);
    document.getElementById('population-cap').textContent = popCap;
    // Season
    let season = window.gameState.season || (window.GameData.seasons ? window.GameData.seasons[0] : 'Spring');
    document.getElementById('season-count').textContent = season;
}

// Update on load and when resources change
document.addEventListener('DOMContentLoaded', function() {
    function tryUpdatePanel() {
        if (window.gameState && window.GameData) {
            updateResourcePanel();
        } else {
            setTimeout(tryUpdatePanel, 200);
        }
    }
    tryUpdatePanel();
    if (window.eventBus) {
        window.eventBus.on && window.eventBus.on('resources-updated', updateResourcePanel);
    }
});
</script>
<script>
// Ensure navigation buttons reflect unlock state on load and after unlocks
function updateNavButtonLocks() {
    if (!window.unlockSystem) return;
    const navBtns = document.querySelectorAll('#view-navigation .nav-btn');
    navBtns.forEach(btn => {
        const view = btn.getAttribute('data-view');
        if (view === 'village') return; // Always unlocked
        if (window.unlockSystem.isViewUnlocked(view)) {
            btn.classList.remove('locked');
            btn.style.opacity = '1';
            btn.style.pointerEvents = 'auto';
        } else {
            btn.classList.add('locked');
            btn.style.opacity = '0.5';
            btn.style.pointerEvents = 'none';
        }
    });
}

// Listen for unlock events and update nav buttons
document.addEventListener('DOMContentLoaded', function() {
    // Initial update after unlockSystem is ready
    function tryUpdateNav() {
        if (window.unlockSystem && typeof window.unlockSystem.isViewUnlocked === 'function') {
            updateNavButtonLocks();
        } else {
            setTimeout(tryUpdateNav, 200);
        }
    }
    tryUpdateNav();

    // Listen for unlock events
    if (window.eventBus) {
        window.eventBus.on && window.eventBus.on('content_unlocked', updateNavButtonLocks);
    } else {
        // Fallback: poll every 2s if eventBus is not available
        setInterval(updateNavButtonLocks, 2000);
    }
});

// Global crafting function
function craftItem(itemType) {
    if (window.gameState) {
        return window.gameState.craftItem(itemType);
    }
    console.log('GameState not available for crafting');
    return false;
}

// Ensure dynasty features are properly initialized
document.addEventListener('DOMContentLoaded', function() {
    // Listen for throne view unlock events
    if (window.eventBus) {
        window.eventBus.on('content_unlocked', function(data) {
            if (data.contentId === 'throne_view' && window.game && window.game.throneManager) {
                console.log('[Dynasty] Throne view unlocked - reinitializing dynasty features');
                // Re-initialize throne manager to show dynasty content
                setTimeout(() => {
                    if (window.game.throneManager.init) {
                        window.game.throneManager.init();
                    }
                }, 100);
            }
        });
    }
});
</script>
