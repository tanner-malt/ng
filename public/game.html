<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Idle: Dynasty Builder</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="game.css">


    <!-- Game Scripts -->
    <script src="../src/config/gameData.js"></script>
    <!-- New Data Model System - Unified Data Definitions -->
    <script src="../src/config/buildingData.js"></script>
    <script src="../src/config/resourceData.js"></script>
    <script src="../src/config/jobData.js"></script>
    <script src="../src/systems/core/eventBus.js"></script>
    <!-- Reactive Data Model System -->
    <script src="../src/systems/core/dataModel.js"></script>
    <script src="../src/systems/core/buildingModel.js"></script>
    <script src="../src/systems/core/resourceModel.js"></script>
    <script src="../src/systems/core/jobModel.js"></script>
    <script src="../src/systems/core/modelInit.js"></script>
    <script src="../src/systems/core/modelBridge.js"></script>
    <!-- World Map Data -->
    <script src="../src/config/worldData.js"></script>
    <script src="../src/systems/core/skillSystem.js"></script>
    <script src="../src/systems/management/populationManager.js"></script>
    <script src="../src/systems/core/gameState.js"></script>
    <script src="../src/systems/management/effectsManager.js"></script>
    <script src="../src/utils/errorRecovery.js"></script>
    <script src="../src/utils/storageManager.js"></script>
    <script src="../src/systems/ui/modalSystem.js"></script>
    <script src="../src/systems/ui/messageHistory.js"></script>
    <script src="../src/systems/features/achievements.js"></script>
    <script src="../src/systems/features/unlockSystem.js"></script>
    <script src="../src/systems/features/techTree.js"></script>
    <script src="../src/systems/features/tutorial.js"></script>
    <script src="../src/systems/management/royalFamily.js"></script>
    <script src="../src/systems/management/buildingEffects.js"></script>
    <script src="../src/systems/features/buildingTutorial.js"></script>
    <script src="../src/systems/features/worldTutorial.js"></script>
    <script src="../src/systems/management/constructionManager.js"></script>
    <script src="../src/systems/management/tileManager.js"></script>
    <script src="../src/systems/management/economySystem.js"></script>
    <script src="../src/systems/features/legacySystem.js"></script>
    <script src="../src/systems/gameplay/village.js"></script>
    <script src="../src/systems/gameplay/throne.js"></script>
    <script src="../src/systems/gameplay/battle.js"></script>
    <script src="../src/systems/gameplay/monarch.js"></script>
    <script src="../src/systems/ui/uiPopups.js"></script>
    <script src="../src/systems/ui/uiBindings.js"></script>
    <script src="../src/systems/core/eventBusIntegrations.js"></script>
    <!-- World map system (terrain, pathfinding, renderer must load before worldManager) -->
    <script src="../src/world/config/terrain.js"></script>
    <script src="../src/world/pathfinding.js"></script>
    <script src="../src/world/mapRenderer.js"></script>
    <script src="../src/systems/gameplay/worldManager.js"></script>
    <script src="../src/systems/gameplay/villageDefense.js"></script>
    <script src="../src/app.js"></script>
    <script src="../src/main.js"></script>
</head>

<body>
    <!-- Read-only save banner -->
    <div id="readonly-banner" style="display:none" aria-live="polite" role="status">
        ‚ö†Ô∏è Read-only mode: This save was created by a newer version. Progress won‚Äôt be saved on this client.
    </div>
    <!-- Popup panels for top-right buttons -->


    <!-- Tutorial Highlight Overlay (legacy, hidden) -->
    <div id="tutorial-highlight-overlay" style="display: none;"></div>

    <!-- Notification overlay and container for tutorial/milestone notifications -->
    <div id="notification-overlay" style="display:none;"></div>
    <div id="notification-container" style="display:flex;"></div>

    <!-- Loading overlay for new players -->
    <div id="game-loading-overlay" class="game-loading-overlay hidden">
        <h1>üëë Dynasty Builder</h1>
        <p>Preparing your realm...</p>
    </div>

    <!-- Game Container -->
    <div id="game-container">
        <!-- Navigation -->
        <nav id="view-navigation">
            <!-- All navigation elements in one flexible container -->
            <div class="nav-container">
                <!-- Version display -->
                <div class="nav-section version-display" id="game-version-display" title="Game Version">
                    <span id="version-text">v0.0.2.1</span>
                </div>

                <!-- View buttons -->
                <div class="nav-section nav-left">
                    <button class="nav-btn active" data-view="village">Village</button>
                    <button class="nav-btn locked" data-view="world">World</button>
                    <button class="nav-btn locked" data-view="research">Research</button>
                    <button class="nav-btn locked" data-view="monarch">Monarch</button>
                    <button class="nav-btn locked" data-view="throne">Throne</button>
                </div>


                <!-- Time controls -->
                <div class="nav-section time-controls-nav" id="global-time-controls">
                    <div class="current-day-nav">
                        <div class="season-info">
                            <span id="current-season-nav">Spring</span>
                            <span id="current-season-day">Day 1</span>
                        </div>
                        <div class="total-day-info">
                            <span>Total:</span>
                            <span id="current-day-number-nav">Day 1</span>
                        </div>
                    </div>
                    <div class="time-btn-group">
                        <button id="pause-btn-nav" class="time-btn pause-btn" title="Pause/Resume">
                            <span id="pause-icon-nav">‚è∏Ô∏è</span>
                        </button>
                        <button id="speed-1x-btn-nav" class="time-btn speed-btn selected" data-speed="2000">1x</button>
                        <button id="speed-2x-btn-nav" class="time-btn speed-btn" data-speed="1000">2x</button>
                        <button id="speed-4x-btn-nav" class="time-btn speed-btn" data-speed="500">4x</button>
                    </div>
                    <button id="end-day-btn-nav" class="end-day-button time-btn" title="Skip to next day">‚è© Next</button>
                </div>

                <!-- Icon buttons -->
                <div class="nav-section nav-right" id="top-right-icons">
                    <button id="royals-btn" class="icon-btn" title="Royal Family" onclick="if(window.villageManager) window.villageManager.showLeadershipOverview();">
                        <span>üëë</span>
                    </button>
                    <button id="sound-btn" class="icon-btn" title="Sound">
                        <span>üîä</span>
                    </button>
                    <button id="message-history-btn" class="icon-btn" title="Message History"
                        style="position: relative;">
                        <span>üìú</span>
                    </button>
                    <button id="settings-btn" class="icon-btn" title="Settings">
                        <span>‚öôÔ∏è</span>
                    </button>
                    <button id="achievements-btn" class="icon-btn achievements-incomplete" title="Achievements">
                        <span id="achievements-icon">üèÜ</span>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Village View -->
        <div id="village-view" class="game-view active">
            <!-- Game Content -->
            <div id="game-content">
                <div class="village-header">
                    <h2>üèòÔ∏è Your Village</h2>
                    <div class="resource-panel">
                        <span><i class="res-icon gold"></i>Gold: <span id="gold-count"></span><span id="gold-cap-wrapper">/<span id="gold-cap"></span></span></span>
                        <span><i class="res-icon food"></i>Food: <span id="food-count"></span>/<span id="food-cap"></span></span>
                        <span><i class="res-icon wood"></i>Wood: <span id="wood-count"></span>/<span id="wood-cap"></span></span>
                        <span><i class="res-icon stone"></i>Stone: <span id="stone-count"></span>/<span id="stone-cap"></span></span>
                        <span id="metal-resource" style="display:none;"><i class="res-icon metal"></i>Metal: <span id="metal-count"></span>/<span id="metal-cap"></span></span>
                        <span id="planks-resource" style="display:none;"><i class="res-icon planks"></i>Planks: <span id="planks-count">0</span>/<span id="planks-cap">50</span></span>
                        <span id="weapons-resource" style="display:none;"><i class="res-icon weapons"></i>Weapons: <span id="weapons-count">0</span>/<span id="weapons-cap">100</span></span>
                        <span id="tools-resource" style="display:none;"><i class="res-icon tools"></i>Tools: <span id="tools-count">0</span>/<span id="tools-cap">100</span></span>
                        <span><i class="res-icon population"></i>Pop: <span id="population-count"></span>/<span id="population-cap"></span></span>
                        <span>üå∏ Season: <span id="season-count"></span></span>
                    </div>
                </div>

                <!-- Objective Bar -->
                <div class="objective-bar">
                    <div class="objective-info">
                        <div class="objective-container">
                            <span class="objective-status" id="objective-status">No Task Selected...</span>
                        </div>
                    </div>
                </div>

                <div class="village-content">
                    <!-- Village Grid (Left Panel) -->
                    <div class="village-grid-panel">
                        <div id="village-grid" class="village-grid">
                            <!-- Generated by village.js -->
                        </div>
                    </div>

                    <!-- Management Panel (Right Panel) -->
                    <div class="management-panel">
                        <!-- Panel Navigation -->
                        <div class="panel-nav">
                            <button class="panel-nav-btn active" data-panel="manager">Overview</button>
                            <button class="panel-nav-btn" data-panel="buildings">Buildings</button>
                            <button class="panel-nav-btn" data-panel="production">Production</button>
                        </div>

                        <!-- Village Manager Tab (Default) -->
                        <div class="panel-tab active" id="manager-tab">
                            <!-- Quick Stats Cards -->
                            <div class="quick-stats-row">
                                <div class="stat-card population-card">
                                    <div class="stat-card-header">
                                        <span class="stat-card-icon">üë•</span>
                                        <span class="stat-card-title">Population</span>
                                    </div>
                                    <div class="stat-card-value">
                                        <span id="manager-population">0</span>
                                        <span class="stat-divider">/</span>
                                        <span id="manager-population-cap" class="stat-cap">0</span>
                                    </div>
                                    <div class="stat-card-trend" id="population-trend">
                                        <span class="trend-value" id="population-net-change">+0</span>
                                        <span class="trend-label">per week</span>
                                    </div>
                                </div>
                                <div class="stat-card workers-card">
                                    <div class="stat-card-header">
                                        <span class="stat-card-icon">‚öí</span>
                                        <span class="stat-card-title">Workers</span>
                                    </div>
                                    <div class="stat-card-value">
                                        <span id="manager-workers-assigned">0</span>
                                        <span class="stat-divider">/</span>
                                        <span id="manager-workers-total" class="stat-cap">0</span>
                                    </div>
                                    <div class="stat-card-detail">
                                        <span id="manager-workers-idle">0</span> idle
                                    </div>
                                </div>
                            </div>

                            <!-- Production Summary -->
                            <div class="production-summary">
                                <div class="summary-header">Daily Production</div>
                                <div class="production-row">
                                    <div class="prod-item">
                                        <span class="prod-icon food">üçû</span>
                                        <span class="prod-value" id="daily-food-net">+0</span>
                                    </div>
                                    <div class="prod-item">
                                        <span class="prod-icon wood">ü™µ</span>
                                        <span class="prod-value" id="daily-wood-net">+0</span>
                                    </div>
                                    <div class="prod-item">
                                        <span class="prod-icon stone">ü™®</span>
                                        <span class="prod-value" id="daily-stone-net">+0</span>
                                    </div>
                                    <div class="prod-item">
                                        <span class="prod-icon metal">‚õèÔ∏è</span>
                                        <span class="prod-value" id="daily-metal-net">+0</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="manager-actions">
                                <button id="population-view-btn" class="action-btn secondary">View Population</button>
                                <button id="jobs-btn" class="action-btn primary">Manage Jobs</button>
                            </div>

                            <!-- Effects Section (Collapsed by default) -->
                            <details class="effects-panel">
                                <summary class="effects-toggle">Active Effects</summary>
                                <div class="effects-content">
                                    <div class="effects-group">
                                        <h5>Weather</h5>
                                        <div id="weather-effects-list" class="effects-list">
                                            <div class="effect-item">
                                                <div class="effect-details">
                                                    <div class="effect-name">Clear Skies</div>
                                                    <div class="effect-description">+10% outdoor work efficiency</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="effects-group">
                                        <h5>Building Bonuses</h5>
                                        <div id="building-effects-list" class="effects-list">
                                            <div class="no-effects">No active building effects</div>
                                        </div>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <!-- Buildings Tab -->
                        <div class="panel-tab" id="buildings-tab">
                            <div id="governing-banner"
                                style="display:none; margin-bottom:8px; padding:10px; border-radius:6px; background: rgba(231,76,60,0.1); border:1px solid rgba(231,76,60,0.4); color:#e74c3c; font-weight:600;">
                                Building is disabled. No leader is Governing. Open Leadership and toggle Governing ON.
                            </div>
                            <div class="building-grid">
                                <div class="building-category">
                                    <h4>Essential Buildings</h4>
                                    <div class="building-row-header">
                                        <div>Building</div>
                                        <div>Description</div>
                                        <div>Resources</div>
                                        <div>Work Pts</div>
                                    </div>
                                    <div class="building-container" id="essential-buildings">
                                        <!-- Basic buildings needed to start -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>Production Buildings</h4>
                                    <div class="building-row-header">
                                        <div>Building</div>
                                        <div>Description</div>
                                        <div>Resources</div>
                                        <div>Work Pts</div>
                                    </div>
                                    <div class="building-container" id="production-buildings">
                                        <!-- Resource gathering and processing -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>Craft & Trade Buildings</h4>
                                    <div class="building-row-header">
                                        <div>Building</div>
                                        <div>Description</div>
                                        <div>Resources</div>
                                        <div>Work Pts</div>
                                    </div>
                                    <div class="building-container" id="craft-buildings">
                                        <!-- Workshops, blacksmiths, markets -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>Military Buildings</h4>
                                    <div class="building-row-header">
                                        <div>Building</div>
                                        <div>Description</div>
                                        <div>Resources</div>
                                        <div>Work Pts</div>
                                    </div>
                                    <div class="building-container" id="military-buildings">
                                        <!-- Defense and training -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>Royal Buildings</h4>
                                    <div class="building-row-header">
                                        <div>Building</div>
                                        <div>Description</div>
                                        <div>Resources</div>
                                        <div>Work Pts</div>
                                    </div>
                                    <div class="building-container" id="royal-buildings">
                                        <!-- Dynasty and prestige -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>Knowledge Buildings</h4>
                                    <div class="building-row-header">
                                        <div>Building</div>
                                        <div>Description</div>
                                        <div>Resources</div>
                                        <div>Work Pts</div>
                                    </div>
                                    <div class="building-container" id="knowledge-buildings">
                                        <!-- Research and learning -->
                                    </div>
                                </div>
                                <div class="building-category">
                                    <h4>üîÆ Advanced Buildings</h4>
                                    <div class="building-row-header">
                                        <div>Building</div>
                                        <div>Description</div>
                                        <div>Resources</div>
                                        <div>Work Pts</div>
                                    </div>
                                    <div class="building-container" id="advanced-buildings">
                                        <!-- Late game and special -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Production Tab -->
                        <div class="panel-tab" id="production-tab">
                            <div class="manager-section">
                                <h4>üìä Daily Production</h4>
                                <div class="production-table">
                                    <div class="production-header">
                                        <div class="column-header">Resource</div>
                                        <div class="column-header">Gain</div>
                                        <div class="column-header">Loss</div>
                                        <div class="column-header">Net</div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">üåæ</span>
                                            <span class="resource-name">Food</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-food-production">0</span></div>
                                        <div class="loss-cell">-<span id="daily-food-consumption">0</span></div>
                                        <div class="net-cell"><span id="daily-food-net">0</span></div>
                                    </div>
                                    <div class="production-sources" id="food-sources">
                                        <div class="sources-detail">Sources: <span class="sources-list"></span></div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">ü™µ</span>
                                            <span class="resource-name">Wood</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-wood-production">0</span></div>
                                        <div class="loss-cell">-<span id="daily-wood-consumption">0</span></div>
                                        <div class="net-cell"><span id="daily-wood-net">0</span></div>
                                    </div>
                                    <div class="production-sources" id="wood-sources">
                                        <div class="sources-detail">Sources: <span class="sources-list"></span></div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">üóø</span>
                                            <span class="resource-name">Stone</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-stone-production">0</span></div>
                                        <div class="loss-cell">-<span id="daily-stone-consumption">0</span></div>
                                        <div class="net-cell"><span id="daily-stone-net">0</span></div>
                                    </div>
                                    <div class="production-sources" id="stone-sources">
                                        <div class="sources-detail">Sources: <span class="sources-list"></span></div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">‚öíÔ∏è</span>
                                            <span class="resource-name">Metal</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-metal-production">0</span></div>
                                        <div class="loss-cell">-<span id="daily-metal-consumption">0</span></div>
                                        <div class="net-cell"><span id="daily-metal-net">0</span></div>
                                    </div>
                                    <div class="production-sources" id="metal-sources">
                                        <div class="sources-detail">Sources: <span class="sources-list"></span></div>
                                    </div>
                                    <div class="production-row">
                                        <div class="resource-cell">
                                            <span class="production-icon">üí∞</span>
                                            <span class="resource-name">Gold</span>
                                        </div>
                                        <div class="gain-cell">+<span id="daily-gold-income">0</span></div>
                                        <div class="loss-cell">-<span id="daily-gold-upkeep">0</span></div>
                                        <div class="net-cell"><span id="daily-gold-net">0</span></div>
                                    </div>
                                    <div class="production-sources" id="gold-sources">
                                        <div class="sources-detail">Sources: <span class="sources-list"></span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- New 2-Panel Layout CSS -->
                    <style>
                        /* Village Content Layout - 2 Panel System */
                        .village-content {
                            display: grid;
                            grid-template-columns: 2fr 1fr;
                            gap: 1rem;
                            width: 100%;
                            height: calc(100vh - 120px);
                            overflow: hidden;
                        }

                        /* Village Grid Panel (Left) */
                        .village-grid-panel {
                            background: #1a1a1a;
                            border: 1px solid #333;
                            border-radius: 8px;
                            padding: 1rem;
                            overflow: auto;
                        }

                        .village-grid {
                            width: 100%;
                            height: 100%;
                        }

                        /* Management Panel (Right) */
                        .management-panel {
                            background: #1a1a1a;
                            border: 1px solid #333;
                            border-radius: 8px;
                            display: flex;
                            flex-direction: column;
                            overflow: hidden;
                        }

                        /* Panel Navigation */
                        .panel-nav {
                            display: flex;
                            background: #222;
                            border-bottom: 1px solid #333;
                            border-radius: 8px 8px 0 0;
                        }

                        .panel-nav-btn {
                            flex: 1;
                            background: #222;
                            color: #e0e0e0;
                            border: none;
                            padding: 12px 8px;
                            cursor: pointer;
                            font-size: 0.9em;
                            font-weight: 500;
                            transition: all 0.2s ease;
                            border-bottom: 3px solid transparent;
                        }

                        .panel-nav-btn:hover {
                            background: #2a2a2a;
                            color: #fff;
                        }

                        .panel-nav-btn.active {
                            background: #2a2a2a;
                            color: #fff;
                            border-bottom-color: #4CAF50;
                        }

                        .panel-nav-btn:first-child {
                            border-radius: 8px 0 0 0;
                        }

                        .panel-nav-btn:last-child {
                            border-radius: 0 8px 0 0;
                        }

                        /* Panel Tabs */
                        .panel-tab {
                            display: none;
                            flex: 1;
                            overflow-y: auto;
                            padding: 1rem;
                        }

                        .panel-tab.active {
                            display: block;
                        }

                        /* Stats Grid */
                        .stats-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 8px;
                            margin-top: 8px;
                        }

                        .stat-item {
                            background: #222;
                            padding: 8px;
                            border-radius: 4px;
                            border: 1px solid #333;
                        }

                        .stat-label {
                            display: block;
                            font-size: 0.8em;
                            color: #bbb;
                            margin-bottom: 2px;
                        }

                        .stat-value {
                            display: block;
                            font-size: 1.1em;
                            font-weight: bold;
                            color: #4CAF50;
                        }

                        /* Building Grid */
                        .building-grid {
                            display: flex;
                            flex-direction: column;
                            gap: 1rem;
                        }

                        .building-category {
                            background: #222;
                            border: 1px solid #333;
                            border-radius: 6px;
                            padding: 12px;
                        }

                        .building-category h4 {
                            margin: 0 0 8px 0;
                            color: #e0e0e0;
                            font-size: 0.9em;
                            border-bottom: 1px solid #333;
                            padding-bottom: 4px;
                        }

                        .building-container {
                            background: rgba(0, 0, 0, 0.2);
                            border-radius: 4px;
                            padding: 4px;
                        }

                        .building-row {
                            display: grid;
                            grid-template-columns: 1.2fr 2fr 1fr 0.5fr;
                            /* Building Name, Description, Resources, Work Points */
                            gap: 8px;
                            padding: 8px;
                            margin-bottom: 4px;
                            border-bottom: 1px solid #333;
                            align-items: center;
                            cursor: pointer;
                            border-radius: 4px;
                            transition: background-color 0.2s ease;
                        }

                        .building-row:hover {
                            background-color: rgba(52, 152, 219, 0.1);
                        }

                        .building-row.locked {
                            opacity: 0.5;
                            cursor: not-allowed;
                        }

                        .building-row.locked:hover {
                            background-color: rgba(231, 76, 60, 0.1);
                        }

                        .building-row-header {
                            display: grid;
                            grid-template-columns: 1.2fr 2fr 1fr 0.5fr;
                            gap: 8px;
                            padding: 8px;
                            font-weight: bold;
                            color: #3498db;
                            border-bottom: 2px solid #3498db;
                            margin-bottom: 8px;
                        }

                        .building-name {
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            font-weight: bold;
                        }

                        .building-resources {
                            font-size: 12px;
                            color: #f39c12;
                        }

                        .building-resources .cost-affordable {
                            color: #27ae60;
                        }
                        .building-resources .cost-unaffordable {
                            color: #e74c3c;
                        }

                        .building-work-points {
                            font-size: 12px;
                            color: #27ae60;
                            text-align: center;
                        }

                        /* Building Buttons */
                        .building-btn {
                            background: #1a1a1a;
                            border: 2px solid #333;
                            border-radius: 6px;
                            padding: 8px;
                            cursor: pointer;
                            transition: all 0.2s ease;
                            color: #e0e0e0;
                            text-align: center;
                        }

                        .building-btn:hover {
                            background: #2a2a2a;
                            border-color: #4CAF50;
                            transform: translateY(-1px);
                        }

                        .building-icon {
                            font-size: 1.5em;
                            margin-bottom: 4px;
                        }

                        .building-name {
                            font-size: 0.8em;
                            font-weight: 600;
                            margin-bottom: 2px;
                            color: #fff;
                        }

                        .building-cost {
                            font-size: 0.7em;
                            color: #bbb;
                        }

                        /* Modal Stats Styling */
                        .stats-grid-modal {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 12px;
                            margin-top: 12px;
                        }

                        .stat-item-modal {
                            background: #333;
                            padding: 12px;
                            border-radius: 6px;
                            border: 1px solid #444;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            text-align: center;
                        }

                        .stat-label-modal {
                            font-size: 0.85em;
                            color: #bbb;
                            margin-bottom: 4px;
                            font-weight: 500;
                        }

                        .stat-value-modal {
                            font-size: 1.3em;
                            font-weight: bold;
                            color: #4CAF50;
                        }

                        /* Responsive Design */
                        @media (max-width: 1200px) {
                            .village-content {
                                grid-template-columns: 1.5fr 1fr;
                            }
                        }

                        @media (max-width: 900px) {
                            .village-content {
                                grid-template-columns: 1fr;
                                grid-template-rows: 1fr auto;
                                height: auto;
                            }

                            .management-panel {
                                max-height: 400px;
                            }
                        }
                    </style>
                    <!-- Time controls now wired in src/app.js: setupAutoPlayButton() -->

                    <!-- Panel Switching JavaScript -->
                    <script>
                        document.addEventListener('DOMContentLoaded', function () {
                            // Panel switching functionality
                            const panelNavBtns = document.querySelectorAll('.panel-nav-btn');
                            const panelTabs = document.querySelectorAll('.panel-tab');

                            panelNavBtns.forEach(btn => {
                                btn.addEventListener('click', function () {
                                    const targetPanel = this.dataset.panel;

                                    // Remove active class from all buttons and tabs
                                    panelNavBtns.forEach(b => b.classList.remove('active'));
                                    panelTabs.forEach(t => t.classList.remove('active'));

                                    // Add active class to clicked button and corresponding tab
                                    this.classList.add('active');
                                    const targetTab = document.getElementById(targetPanel + '-tab');
                                    if (targetTab) {
                                        targetTab.classList.add('active');
                                    }

                                    // Update building tabs when buildings panel is opened
                                    if (targetPanel === 'buildings') {
                                        updateBuildingGrid();
                                    }
                                });
                            });

                            // Update stats display
                            function updateStatsDisplay() {
                                if (window.gameState && window.gameState.stats) {
                                    const stats = window.gameState.stats;

                                    // Update stat values if elements exist
                                    const totalDaysEl = document.getElementById('stat-total-days');
                                    if (totalDaysEl) totalDaysEl.textContent = stats.totalDaysElapsed || 1;

                                    const peakPopEl = document.getElementById('stat-peak-population');
                                    if (peakPopEl) peakPopEl.textContent = stats.peakPopulation || 1;

                                    const buildingsEl = document.getElementById('stat-buildings-built');
                                    if (buildingsEl) buildingsEl.textContent = stats.buildingsBuilt || 0;

                                    const seasonsEl = document.getElementById('stat-seasons-passed');
                                    if (seasonsEl) seasonsEl.textContent = Math.floor((stats.totalDaysElapsed || 1) / 28) || 0;
                                }
                            }

                            // Update building grid in buildings tab
                            function updateBuildingGrid() {
                                // Prefer the VillageManager renderer which creates full-width rows
                                // with 3 columns: name, resources, work points.
                                if (window.villageManager &&
                                    typeof window.villageManager.generateBuildingButtons === 'function' &&
                                    typeof window.villageManager.setupBuildingButtons === 'function') {
                                    try {
                                        window.villageManager.generateBuildingButtons();
                                        window.villageManager.setupBuildingButtons();
                                        // After rows are generated, show banner if not allowed to manage
                                        try {
                                            const banner = document.getElementById('governing-banner');
                                            const allowed = window.villageManager.isManagementAllowed();
                                            if (banner) {
                                                banner.style.display = allowed ? 'none' : 'block';
                                            }
                                        } catch (e) { console.warn('[BuildingsTab] governing banner update failed', e); }
                                        return; // Done ‚Äì use the new structured rows
                                    } catch (err) {
                                        console.warn('[BuildingsTab] Falling back to simple buttons:', err);
                                    }
                                }

                                // Fallback: simple button list (legacy)
                                const containers = {
                                    essential: document.getElementById('essential-buildings'),
                                    production: document.getElementById('production-buildings'),
                                    craft: document.getElementById('craft-buildings'),
                                    military: document.getElementById('military-buildings'),
                                    royal: document.getElementById('royal-buildings'),
                                    knowledge: document.getElementById('knowledge-buildings'),
                                    advanced: document.getElementById('advanced-buildings')
                                };
                                Object.values(containers).forEach(el => el && (el.innerHTML = ''));
                                if (!window.GameData) return;
                                Object.entries(containers).forEach(([category, el]) => {
                                    if (!el) return;
                                    const buildings = window.GameData.getBuildingsByCategory
                                        ? window.GameData.getBuildingsByCategory(category)
                                        : (window.GameData.buildingCategories?.[category] || []);
                                    buildings.forEach(type => {
                                        const btn = document.createElement('button');
                                        btn.className = 'building-btn';
                                        const icon = window.GameData?.getBuildingIcon
                                            ? window.GameData.getBuildingIcon(type)
                                            : (window.GameData?.buildingInfo?.[type]?.icon || 'üè†');
                                        const name = window.GameData?.getBuildingName
                                            ? window.GameData.getBuildingName(type)
                                            : (window.GameData?.buildingInfo?.[type]?.name || type);
                                        const cost = window.GameData?.formatCost
                                            ? window.GameData.formatCost(type)
                                            : '';
                                        btn.innerHTML = `
                                            <div class="building-icon">${icon}</div>
                                            <div class="building-name">${name}</div>
                                            <div class="building-cost">${cost}</div>`;
                                        btn.addEventListener('click', function () {
                                            if (window.village && typeof window.village.buildBuilding === 'function') {
                                                window.village.buildBuilding(type);
                                            }
                                        });
                                        el.appendChild(btn);
                                    });
                                });
                            }

                            // Format cost display (fallback only)
                            function formatCost(cost) {
                                if (window.GameData?.formatCost && typeof cost === 'string') return cost;
                                if (!cost) return '';
                                const costParts = [];
                                if (cost.food) costParts.push(`${cost.food}üåæ`);
                                if (cost.wood) costParts.push(`${cost.wood}ü™µ`);
                                if (cost.stone) costParts.push(`${cost.stone}üóø`);
                                if (cost.metal) costParts.push(`${cost.metal}‚öíÔ∏è`);
                                if (cost.production) costParts.push(`${cost.production}‚öôÔ∏è`);
                                if (cost.gold) costParts.push(`${cost.gold}üí∞`);
                                if (cost.planks) costParts.push(`${cost.planks}ü™µ`);
                                return costParts.join(' ');
                            }

                            // Update display on game events
                            if (window.eventBus) {
                                window.eventBus.on('day-ended', updateStatsDisplay);
                                window.eventBus.on('resources-updated', updateStatsDisplay);
                                window.eventBus.on('building-built', updateBuildingGrid);
                            }

                            // Initial update
                            setTimeout(() => {
                                updateStatsDisplay();
                                updateBuildingGrid();
                            }, 500);
                        });
                    </script>
                </div>
            </div>
        </div>
    </div>

    <!-- World View -->
    <div id="world-view" class="game-view">
        <!-- WorldManager will populate this dynamically -->

        <!-- Battle Modal (hidden by default) -->
        <div id="battle-modal" class="battle-modal" style="display: none;">
            <div class="battle-modal-content">
                <div class="battle-header">
                    <h2>‚öîÔ∏è Battle: <span id="battle-location">Northern Plains</span></h2>
                    <button id="close-battle-modal" class="close-btn">√ó</button>
                    <div class="weather-terrain-display">
                        <span id="weather-display">üå§Ô∏è Clear</span>
                        <span id="terrain-display">üåæ Plains</span>
                    </div>
                </div>

                <div class="battle-content">
                    <!-- Battle Viewing Options -->
                    <div class="battle-options">
                        <button id="watch-battle-btn" class="btn primary">‚ñ∂Ô∏è Watch Battle</button>
                        <button id="auto-resolve-btn" class="btn">‚ö° Auto-Resolve</button>
                        <button id="pause-battle-btn" class="btn" style="display: none;">‚è∏Ô∏è Pause</button>
                    </div>

                    <!-- Battle Field -->
                    <div class="battle-field-container">
                        <div id="battle-field" class="battle-field">
                            <!-- Battle visualization will be rendered here -->
                        </div>

                        <!-- Battle Controls -->
                        <div class="battle-controls">
                            <div class="battle-speed-controls">
                                <button id="speed-1x" class="speed-btn active">1x</button>
                                <button id="speed-2x" class="speed-btn">2x</button>
                                <button id="speed-4x" class="speed-btn">4x</button>
                            </div>
                        </div>
                    </div>

                    <!-- Battle Progress -->
                    <div class="battle-progress">
                        <div class="army-status">
                            <div class="player-army">
                                <h4>üõ°Ô∏è Your Army</h4>
                                <div id="player-army-units"></div>
                            </div>
                            <div class="enemy-army">
                                <h4>‚öîÔ∏è Enemy Army</h4>
                                <div id="enemy-army-units"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Battle Log -->
                    <div class="battle-log-panel">
                        <h3>üìú Battle Log</h3>
                        <div id="battle-log" class="battle-log">
                            <div class="log-entry">Battle ready to begin...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Monarch View -->
    <div id="monarch-view" class="game-view">
        <div class="locked-view">
            <h2>üëë Monarch's Court</h2>
            <p class="lock-message">This feature will be unlocked as you progress through the game.</p>
        </div>

        <!-- Unlocked Monarch Content -->
        <div id="monarch-content" class="monarch-content" style="display: none;">
            <div class="monarch-header">
                <h2>üëë Royal Court & Dynasty Management</h2>
                <div id="monarch-gold-display" class="gold-display">üí∞ 0 Gold</div>
            </div>

            <!-- Current Monarch Card & Family Tree -->
            <div class="monarch-section monarch-overview">
                <div class="monarch-overview-grid">
                    <div>
                        <h3>üëë Current Monarch</h3>
                        <div id="monarch-card">
                            <!-- Populated by monarch.js -->
                        </div>
                    </div>
                    <div>
                        <h3>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Royal Family</h3>
                        <div id="monarch-family-tree">
                            <!-- Populated by monarch.js -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Royal Investment System -->
            <div class="monarch-section">
                <h3>üí∞ Royal Investments</h3>
                <div id="investment-categories" class="investment-categories">
                    <!-- Dynamically populated by monarch.js renderInvestments() -->
                </div>
            </div>

            <!-- Legacy Bonus Spending -->
            <div class="monarch-section">
                <h3>üèõÔ∏è Legacy Bonuses</h3>
                <div class="legacy-bonuses-header">
                    <span id="legacy-points-display" class="legacy-points-badge">0 Legacy Points</span>
                    <p style="color:#95a5a6;font-size:0.85em;margin:4px 0 0;">Spend legacy points to improve starting conditions for future dynasties</p>
                </div>
                <div id="legacy-bonuses-grid" class="legacy-bonuses-grid">
                    <!-- Dynamically populated by monarch.js renderLegacyBonuses() -->
                </div>
            </div>

            <!-- Dynasty Reset Tools -->
            <div class="monarch-section">
                <h3>‚ö∞Ô∏è Dynasty Management</h3>
                <div class="dynasty-tools">
                    <div class="dynasty-info">
                        <h4>üìä Current Dynasty Status</h4>
                        <div id="dynasty-stats" class="dynasty-stats">
                            <!-- Will be populated by monarch.js -->
                        </div>
                    </div>

                    <div class="prestige-actions">
                        <h4>üîÑ Dynasty Actions</h4>
                        <button id="calculate-inheritance-btn" class="dynasty-btn">üí∞ Calculate Inheritance</button>
                        <button id="prestige-reset-btn" class="dynasty-btn danger">‚ö∞Ô∏è End Dynasty (Prestige
                            Reset)</button>
                    </div>
                </div>
            </div>

            <!-- Investment Status Display -->
            <div class="monarch-section">
                <h3>üìà Active Investments</h3>
                <div id="investment-status" class="investment-status">
                    <!-- Will be populated by monarch.js -->
                </div>
            </div>
        </div>
    </div>

    <!-- Research View -->
    <div id="research-view" class="game-view">
        <div class="locked-view">
            <h2>üî¨ Research</h2>
            <p class="lock-message">Build an Academy to unlock technology research.</p>
        </div>

        <div id="research-content" class="research-content" style="display: none;">
            <div class="research-header">
                <h2>üî¨ Technology Research</h2>
                <div class="research-stats">
                    <span class="research-points">üß™ Research Points: <strong id="research-rp">0</strong></span>
                    <span class="research-rate" id="research-rate-display"></span>
                </div>
            </div>

            <!-- Current Research -->
            <div id="current-research-panel" class="current-research-panel" style="display: none;">
                <h3>üìñ Currently Researching</h3>
                <div class="current-research-info">
                    <span id="current-research-name" class="current-research-name"></span>
                    <div class="research-progress-bar">
                        <div id="research-progress-fill" class="research-progress-fill" style="width: 0%"></div>
                    </div>
                    <span id="research-progress-text" class="research-progress-text">0%</span>
                </div>
            </div>

            <!-- Tech Tree -->
            <div id="tech-tree-container" class="tech-tree-container">
                <!-- Tier sections populated by techTree.js -->
            </div>
        </div>
    </div>

    <!-- Throne View -->
    <div id="throne-view" class="game-view">
        <div class="locked-view">
            <h2>üè∞ The Throne</h2>
            <p class="lock-message">This feature will be unlocked as you progress through the game.</p>
        </div>

        <!-- Unlocked Throne Content -->
        <div id="throne-content" class="throne-content" style="display: none;">
            <div class="throne-header">
                <h2>üè∞ The Royal Throne</h2>
                <p>Manage your dynasty, royal family, and ceremonial artifacts</p>
            </div>

            <!-- Throne Navigation Tabs -->
            <div class="throne-tabs">
                <button class="throne-tab-btn active" data-tab="dynasty">üëë Dynasty</button>
                <button class="throne-tab-btn" data-tab="equipment">‚öîÔ∏è Equipment</button>
                <button class="throne-tab-btn" data-tab="merge">‚ú® Artifacts</button>
                <button class="throne-tab-btn" data-tab="court">üèõÔ∏è Court</button>
            </div>

            <!-- Dynasty Tab -->
            <div id="dynasty-tab" class="throne-tab active">
                <div class="dynasty-content">
                    <!-- Current Monarch Section -->
                    <div class="dynasty-section">
                        <h3>üëë Current Monarch</h3>
                        <div id="current-monarch" class="monarch-card">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Royal Family Tree -->
                    <div class="dynasty-section">
                        <h3>üå≥ Royal Family</h3>
                        <div id="royal-family-tree" class="family-tree">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Marriage & Heirs -->
                    <div class="dynasty-section">
                        <h3>üíí Marriage & Succession</h3>
                        <div class="dynasty-actions">
                            <button id="arrange-marriage-btn" class="dynasty-btn">üíí Arrange Marriage</button>
                            <button id="hire-tutor-btn" class="dynasty-btn">üéì Hire Tutors</button>
                            <button id="succession-plan-btn" class="dynasty-btn">üìú Succession Plan</button>
                        </div>
                        <div id="succession-order" class="succession-list">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>

                    <!-- Dynasty Stats -->
                    <div class="dynasty-section">
                        <h3>üìä Dynasty Legacy</h3>
                        <div id="dynasty-stats" class="dynasty-stats">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Tab -->
            <div id="equipment-tab" class="throne-tab">
                <div class="equipment-content">
                    <div class="equipment-header">
                        <h3>‚öîÔ∏è Royal Armory</h3>
                        <p>Manage weapons, armor, and equipment for your armies and royal guard</p>
                    </div>

                    <div class="equipment-sections">
                        <!-- Current Equipment -->
                        <div class="equipment-section">
                            <h4>üëë Royal Equipment</h4>
                            <div id="royal-equipment" class="equipped-items">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>

                        <!-- Equipment Categories -->
                        <div class="equipment-section">
                            <h4>üó°Ô∏è Available Equipment</h4>
                            <div class="equipment-tabs">
                                <button class="equipment-category-btn active" data-category="weapons">‚öîÔ∏è
                                    Weapons</button>
                                <button class="equipment-category-btn" data-category="armor">üõ°Ô∏è Armor</button>
                                <button class="equipment-category-btn" data-category="tools">üî® Tools</button>
                                <button class="equipment-category-btn" data-category="magical">‚ú® Magical</button>
                            </div>
                            <div id="equipment-list" class="equipment-inventory">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Artifacts Tab -->
            <div id="merge-tab" class="throne-tab">
                <div class="throne-merge-content">
                    <div class="merge-header">
                        <h3>‚ú® Royal Artifacts</h3>
                        <p>Merge ceremonial items to create powerful artifacts</p>
                    </div>

                    <div class="merge-container">
                        <div id="merge-grid" class="merge-grid">
                            <!-- Throne merge system will populate this -->
                        </div>

                        <div class="merge-info">
                            <h4>üéÅ Active Bonuses</h4>
                            <div id="active-bonuses">
                                <p>No bonuses yet - start merging!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Court Tab -->
            <div id="court-tab" class="throne-tab">
                <div class="court-content">
                    <h3>üèõÔ∏è Royal Court</h3>
                    <p>Manage advisors, nobles, and court affairs</p>
                    <div id="court-affairs" class="court-panel">
                        <!-- Will be populated by JS -->
                        <p style="color: #888; font-style: italic;">Court management coming in future updates...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>

    <style>
        /* Enhanced Day Control Buttons */
        .day-controls button.end-day-button,
        .day-controls button.auto-play-button {
            background: #222;
            color: #e0e0e0;
            border: 1px solid #333;
            border-radius: 5px;
            padding: 7px 16px;
            font-size: 1em;
            font-weight: 500;
            margin: 8px 0 0 0;
            box-shadow: none;
            cursor: pointer;
            transition: background 0.15s, color 0.15s, border 0.15s;
            outline: none;
            letter-spacing: 0.2px;
            position: relative;
        }

        .day-controls button.end-day-button,
        .day-controls button.auto-play-button {
            margin-right: 6px;
        }

        .day-controls button.end-day-button:last-child,
        .day-controls button.auto-play-button:last-child {
            margin-right: 0;
        }

        .day-controls button.end-day-button:hover,
        .day-controls button.auto-play-button:hover {
            background: #292f36;
            color: #fff;
            border-color: #444;
        }

        .day-controls button.end-day-button:active,
        .day-controls button.auto-play-button:active {
            background: #181c20;
            color: #b0b0b0;
            border-color: #222;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-10px);
            }

            60% {
                transform: translateY(-5px);
            }
        }

        .tutorial-highlight {
            position: relative;
            box-shadow: 0 0 8px rgba(243, 156, 18, 0.4) !important;
            border: 2px solid #f39c12 !important;
            background: rgba(243, 156, 18, 0.08) !important;
        }

        /* Locked building button styles */
        .build-btn.locked {
            opacity: 0.5;
            background: #555 !important;
            color: #888 !important;
            cursor: not-allowed;
            position: relative;
        }

        .build-btn.locked::before {
            content: 'üîí';
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 12px;
        }

        .build-btn.locked:hover {
            background: #555 !important;
            transform: none;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>

    <style>
        /* Battle Modal Styles */
        .battle-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .battle-modal-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            width: 95%;
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close-btn:hover {
            color: #000;
        }

        .battle-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            margin-right: 40px;
            padding: 15px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 10px;
            color: white;
        }

        .weather-terrain-display {
            display: flex;
            gap: 15px;
            font-size: 14px;
        }

        .battle-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .battle-options {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .battle-field-container,
        .battle-progress,
        .battle-log-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
        }

        .battle-field {
            height: 300px;
            background: #e8f5e8;
            border: 2px solid #27ae60;
            border-radius: 8px;
            position: relative;
            margin-bottom: 15px;
        }

        .battle-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .battle-speed-controls {
            display: flex;
            gap: 5px;
        }

        .speed-btn {
            padding: 5px 12px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .speed-btn.active {
            background: #3498db;
            color: white;
        }

        .army-status {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .player-army,
        .enemy-army {
            background: white;
            border-radius: 8px;
            padding: 15px;
            border: 2px solid #ddd;
        }

        .player-army {
            border-color: #27ae60;
        }

        .enemy-army {
            border-color: #e74c3c;
        }

        .battle-log {
            height: 150px;
            overflow-y: auto;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .log-entry:nth-child(even) {
            background: #f8f9fa;
        }

        .army-unit-card {
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .army-unit-card:hover {
            border-color: #3498db;
            transform: translateY(-2px);
        }

        .unit-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .unit-type {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .unit-stats {
            font-size: 12px;
            color: #7f8c8d;
        }

        .battle-field {
            background: linear-gradient(135deg, #f1c40f, #f39c12);
            border: 3px solid #d35400;
            border-radius: 10px;
            height: 400px;
            position: relative;
            overflow: hidden;
            margin: 15px 0;
        }

        .battle-unit,
        .battle-enemy {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            border: 2px solid #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .battle-unit {
            background: #27ae60;
            color: white;
        }

        .battle-enemy {
            background: #e74c3c;
            color: white;
        }

        .army-actions,
        .battle-controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn.primary {
            background: #3498db;
            color: white;
        }

        .btn.primary:hover {
            background: #2980b9;
        }

        .btn:not(.primary) {
            background: #95a5a6;
            color: white;
        }

        .btn:not(.primary):hover {
            background: #7f8c8d;
        }

        .battle-log {
            max-height: 150px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 10px;
            margin-top: 10px;
        }

        .log-entry {
            padding: 2px 0;
            font-size: 14px;
            border-bottom: 1px solid #f0f0f0;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        /* Monarch View Styles */
        .monarch-content {
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 2rem;
            overflow-y: auto;
            height: calc(100vh - 120px);
        }

        .monarch-header {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid #1abc9c;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
        }

        .monarch-header h2 {
            margin: 0 0 0.5rem 0;
            color: #f1c40f;
            font-size: 2rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .gold-display {
            font-size: 1.4rem;
            font-weight: bold;
            color: #f1c40f;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            white-space: nowrap;
        }

        .monarch-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .monarch-overview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .monarch-overview-grid h3 {
            color: #f1c40f;
            margin: 0 0 1rem 0;
            border-bottom: 2px solid rgba(241, 196, 15, 0.3);
            padding-bottom: 0.5rem;
        }

        .monarch-section {
            background: #222;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .monarch-section h3 {
            color: #1abc9c;
            margin: 0 0 1rem 0;
            font-size: 1.4rem;
            border-bottom: 2px solid #333;
            padding-bottom: 0.5rem;
        }

        .investment-categories {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .investment-category {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1rem;
        }

        .investment-category h4 {
            color: #f39c12;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
        }

        .investment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .investment-item {
            background: #1a1a1a;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .investment-item:hover {
            border-color: #1abc9c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 188, 156, 0.3);
        }

        .investment-icon {
            font-size: 2rem;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #34495e, #2c3e50);
            border-radius: 50%;
            border: 2px solid #1abc9c;
            box-shadow: 0 2px 8px rgba(26, 188, 156, 0.2);
        }

        .investment-details {
            flex: 1;
        }

        .investment-details h5 {
            color: #ecf0f1;
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
        }

        .investment-details p {
            color: #bdc3c7;
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
        }

        .investment-cost {
            color: #f1c40f;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .investment-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(39, 174, 96, 0.3);
        }

        .investment-btn:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.4);
        }

        .investment-btn:disabled {
            background: #555;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .investment-level {
            font-size: 0.8rem;
            color: #1abc9c;
            font-weight: 600;
            margin-top: 0.25rem;
        }

        .advisor-panel {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border-radius: 8px;
            padding: 1.5rem;
            border: 2px solid #1abc9c;
        }

        .advisor-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .advisor-header h4 {
            color: #f1c40f;
            margin: 0;
        }

        .advisor-icon {
            font-size: 1.5rem;
        }

        .advisor-advice-item {
            margin-bottom: 0.75rem;
            font-style: italic;
            color: #ecf0f1;
            line-height: 1.5;
        }

        .advisor-advice-empty {
            font-style: italic;
            color: #ddd;
        }

        .advisor-buttons {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .advisor-btn {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.15);
            color: white;
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .advisor-btn:hover {
            background: rgba(255,255,255,0.25);
            border-color: rgba(255,255,255,0.4);
        }

        .advisor-btn.active {
            background: #1abc9c;
            border-color: #16a085;
        }

        .dynasty-tools {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .dynasty-info,
        .prestige-actions {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .dynasty-info h4,
        .prestige-actions h4 {
            color: #e74c3c;
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
        }

        .dynasty-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            font-weight: bold;
            margin: 0.5rem 0.5rem 0.5rem 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(52, 152, 219, 0.3);
        }

        .dynasty-btn:hover {
            background: linear-gradient(135deg, #2980b9, #3498db);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }

        .dynasty-btn.danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
        }

        .dynasty-btn.danger:hover {
            background: linear-gradient(135deg, #c0392b, #e74c3c);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .investment-status {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 1.5rem;
        }

        .dynasty-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .dynasty-stat {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 1rem;
            text-align: center;
        }

        .dynasty-stat-label {
            color: #bdc3c7;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .dynasty-stat-value {
            color: #f1c40f;
            font-size: 1.5rem;
            font-weight: bold;
        }

        /* Legacy System Styles */
        .dynasty-stat-group {
            margin-bottom: 1.5rem;
        }

        .dynasty-stat-group h4 {
            color: #ecf0f1;
            margin: 0 0 12px 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #34495e;
        }

        .dynasty-stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .legacy-stats {
            background: linear-gradient(135deg, rgba(52, 73, 94, 0.3) 0%, rgba(44, 62, 80, 0.3) 100%);
            border: 1px solid #3498db;
            border-radius: 8px;
            padding: 16px;
        }

        .legacy-titles {
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid #34495e;
        }

        .legacy-titles h5,
        .legacy-bonuses h5 {
            color: #bdc3c7;
            font-size: 0.9em;
            margin: 0 0 8px 0;
        }

        .title-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .title-badge {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: #fff;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .legacy-bonuses {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #34495e;
        }

        .bonus-list {
            list-style: none;
            padding: 0;
            margin: 0;
            color: #2ecc71;
            font-size: 0.9em;
        }

        .bonus-list li {
            padding: 4px 0;
        }

        .dynasty-btn.danger {
            background: linear-gradient(135deg, #c0392b 0%, #e74c3c 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.2s;
        }

        .dynasty-btn.danger:hover {
            background: linear-gradient(135deg, #a93226 0%, #c0392b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dynasty-tools {
                grid-template-columns: 1fr;
            }

            .investment-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .monarch-content {
                padding: 1rem;
            }

            .monarch-header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.5rem;
            }

            .monarch-header h2 {
                font-size: 1.5rem;
            }

            .monarch-overview-grid {
                grid-template-columns: 1fr;
            }

            .investment-item {
                flex-direction: column;
                text-align: center;
            }
        }

        /* Inheritance Calculation Modal Styles */
        .dynasty-calculation {
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 1rem;
            border-radius: 8px;
        }

        .inheritance-breakdown {
            margin: 1rem 0;
        }

        .inheritance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #333;
        }

        .inheritance-item:last-child {
            border-bottom: none;
        }

        .inheritance-label {
            color: #bdc3c7;
            font-size: 0.9rem;
        }

        .inheritance-value {
            color: #f1c40f;
            font-weight: bold;
        }

        .inheritance-total {
            background: #2a2a2a;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .inheritance-total .inheritance-label {
            color: #ecf0f1;
            font-size: 1rem;
        }

        .inheritance-total .inheritance-value {
            color: #2ecc71;
            font-size: 1.2rem;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .battle-content {
                grid-template-columns: 1fr;
            }

            .commander-panel,
            .army-panel {
                grid-column: 1;
            }

            .battle-field-container,
            .battle-log-panel {
                grid-column: 1;
            }
        }
    </style>
    <script>
        // --- View Switching System (delegates to Game) ---
        let worldManager = null;

        // Primary: delegate to Game.switchView; Fallback: minimal DOM toggle
        function switchView(view) {
            const app = window.app || window.game;
            if (app && typeof app.switchView === 'function') {
                app.switchView(view);
                return;
            }
            // Fallback if app not ready
            const viewEl = document.getElementById(view + '-view');
            if (!viewEl) {
                console.warn('[ViewSystem] Invalid view requested (fallback):', view);
                return;
            }
            document.querySelectorAll('.game-view').forEach(el => el.classList.remove('active'));
            viewEl.classList.add('active');
            document.querySelectorAll('#view-navigation .nav-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });
        }

        // Restore uses same delegation
        function restoreView(view) {
            const app = window.app || window.game;
            if (app && typeof app.switchView === 'function') {
                app.switchView(view);
                return;
            }
            // Fallback to ensure something is visible
            switchView(view || 'village');
        }

        // Expose globally for existing callers (e.g., worldManager, gameState)
        window.switchView = switchView;
        window.restoreView = restoreView;

        // Note: Navigation click handlers are set up by Game.setupNavigation().
        // We intentionally avoid binding duplicate listeners here to prevent race conditions.
    </script>
    <!-- Moved trailing scripts before closing body to ensure valid HTML structure -->
    <script>
        // Ensure all views live under #game-container for correct sizing/layout
        document.addEventListener('DOMContentLoaded', function () {
            const root = document.getElementById('game-container');
            if (!root) return;
            ['world-view', 'research-view', 'monarch-view', 'throne-view'].forEach(id => {
                const el = document.getElementById(id);
                if (el && !root.contains(el)) {
                    try {
                        root.appendChild(el);
                        console.log('[ViewStructure] Moved #' + id + ' under #game-container');
                    } catch (e) {
                        console.warn('[ViewStructure] Could not relocate #' + id, e);
                    }
                }
            });
        });
        // On hover, check if locked nav button can be unlocked and unlock if requirements are met
        document.addEventListener('DOMContentLoaded', function () {
            const navBtns = document.querySelectorAll('#view-navigation .nav-btn');
            navBtns.forEach(btn => {
                btn.addEventListener('mouseenter', function () {
                    if (btn.classList.contains('locked')) {
                        const view = btn.getAttribute('data-view');
                        if (window.unlockSystem && typeof window.unlockSystem.isViewUnlocked === 'function') {
                            // Check if requirements are now met
                            const unlockId = view + '_view';
                            if (window.unlockSystem.checkUnlockConditions && window.unlockSystem.checkUnlockConditions(unlockId)) {
                                // Unlock it
                                window.unlockSystem.unlock(unlockId);
                                // UI will update via eventBus or polling
                            }
                        }
                    }
                });
            });
        });
        // Dynamically update resource and season values from gameState and gameData
        function updateResourcePanel() {
            if (!window.gameState || !window.GameData) return;
            const resources = window.gameState.resources || {};
            document.getElementById('gold-count').textContent = resources.gold ?? 0;
            document.getElementById('food-count').textContent = resources.food ?? 0;
            document.getElementById('wood-count').textContent = resources.wood ?? 0;
            document.getElementById('stone-count').textContent = resources.stone ?? 0;
            document.getElementById('metal-count').textContent = resources.metal ?? 0;
            document.getElementById('planks-count').textContent = resources.planks ?? 0;
            document.getElementById('weapons-count').textContent = resources.weapons ?? 0;
            document.getElementById('tools-count').textContent = resources.tools ?? 0;
            document.getElementById('population-count').textContent = window.gameState.population ?? 0;
            
            // Show advanced resources once they become relevant (have value or building exists)
            const buildings = window.gameState.buildings || [];
            const hasMine = buildings.some(b => b.type === 'mine' && b.level > 0);
            const hasLumberMill = buildings.some(b => b.type === 'lumberMill' && b.level > 0);
            const hasBlacksmith = buildings.some(b => b.type === 'blacksmith' && b.level > 0);
            
            const metalEl = document.getElementById('metal-resource');
            const planksEl = document.getElementById('planks-resource');
            const weaponsEl = document.getElementById('weapons-resource');
            const toolsEl = document.getElementById('tools-resource');
            
            if (metalEl && (resources.metal > 0 || hasMine)) metalEl.style.display = '';
            if (planksEl && (resources.planks > 0 || hasLumberMill)) planksEl.style.display = '';
            if (weaponsEl && (resources.weapons > 0 || hasBlacksmith)) weaponsEl.style.display = '';
            if (toolsEl && (resources.tools > 0 || hasBlacksmith)) toolsEl.style.display = '';
            
            // Use cap from GameData if available, else fallback to gameState
            let popCap = (window.GameData.resourceCaps && window.GameData.resourceCaps.population) ? window.GameData.resourceCaps.population : (window.gameState.populationCap ?? 0);
            document.getElementById('population-cap').textContent = popCap;
            // Season
            let season = window.gameState.season || (window.GameData.seasons ? window.GameData.seasons[0] : 'Spring');
            document.getElementById('season-count').textContent = season;
        }

        // Update on load and when resources change
        document.addEventListener('DOMContentLoaded', function () {
            function tryUpdatePanel() {
                if (window.gameState && window.GameData) {
                    updateResourcePanel();
                } else {
                    setTimeout(tryUpdatePanel, 200);
                }
            }
            tryUpdatePanel();
            if (window.eventBus) {
                window.eventBus.on && window.eventBus.on('resources-updated', updateResourcePanel);
            }
        });
    </script>
    <script>
        // Ensure navigation buttons reflect unlock state on load and after unlocks
        function updateNavButtonLocks() {
            if (!window.unlockSystem) return;
            const navBtns = document.querySelectorAll('#view-navigation .nav-btn');
            navBtns.forEach(btn => {
                const view = btn.getAttribute('data-view');
                if (view === 'village') return; // Always unlocked
                if (window.unlockSystem.isViewUnlocked(view)) {
                    btn.classList.remove('locked');
                    btn.style.opacity = '1';
                    btn.style.pointerEvents = 'auto';
                } else {
                    btn.classList.add('locked');
                    btn.style.opacity = '0.5';
                    btn.style.pointerEvents = 'none';
                }
            });
        }

        // Listen for unlock events and update nav buttons
        document.addEventListener('DOMContentLoaded', function () {
            // Initial update after unlockSystem is ready
            function tryUpdateNav() {
                if (window.unlockSystem && typeof window.unlockSystem.isViewUnlocked === 'function') {
                    updateNavButtonLocks();
                } else {
                    setTimeout(tryUpdateNav, 200);
                }
            }
            tryUpdateNav();

            // Listen for unlock events
            if (window.eventBus) {
                window.eventBus.on && window.eventBus.on('content_unlocked', updateNavButtonLocks);
            } else {
                // Fallback: poll every 2s if eventBus is not available
                setInterval(updateNavButtonLocks, 2000);
            }
        });

        // Global crafting function
        function craftItem(itemType) {
            if (window.gameState) {
                return window.gameState.craftItem(itemType);
            }
            console.log('GameState not available for crafting');
            return false;
        }
    </script>
    <script>
        // Ensure dynasty features are properly initialized
        document.addEventListener('DOMContentLoaded', function () {
            // Listen for throne view unlock events
            if (window.eventBus) {
                window.eventBus.on('content_unlocked', function (data) {
                    if (data.contentId === 'throne_view' && window.game && window.game.throneManager) {
                        console.log('[Dynasty] Throne view unlocked - reinitializing dynasty features');
                        // Re-initialize throne manager to show dynasty content
                        setTimeout(() => {
                            if (window.game.throneManager.init) {
                                window.game.throneManager.init();
                            }
                        }, 100);
                    }
                });
            }
        });
    </script>
</body>

</html>