<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Defense: Idleo - Full Debug</title>
    <link rel="stylesheet" href="public/game.css">
    <style>
        body {
            background: #1a1a1a;
            color: #ecf0f1;
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
        }
        
        .debug-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            background: rgba(44, 62, 80, 0.95);
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            z-index: 9999;
            max-height: 80vh;
            overflow-y: auto;
            font-size: 12px;
        }
        
        .debug-section {
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(52, 73, 94, 0.7);
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }
        
        .debug-section h4 {
            margin: 0 0 8px 0;
            color: #3498db;
            font-size: 14px;
        }
        
        .debug-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 10px;
            margin: 2px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
        }
        
        .debug-btn:hover {
            background: #2980b9;
        }
        
        .debug-btn.success { background: #27ae60; }
        .debug-btn.success:hover { background: #229954; }
        .debug-btn.warning { background: #f39c12; }
        .debug-btn.warning:hover { background: #e67e22; }
        .debug-btn.danger { background: #e74c3c; }
        .debug-btn.danger:hover { background: #c0392b; }
        
        .debug-info {
            background: rgba(26, 188, 156, 0.1);
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 11px;
            border-left: 3px solid #1abc9c;
        }
        
        .debug-log {
            background: rgba(0, 0, 0, 0.3);
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 10px;
            max-height: 100px;
            overflow-y: auto;
            color: #2ecc71;
            margin-top: 5px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-ok { background: #2ecc71; }
        .status-warning { background: #f39c12; }
        .status-error { background: #e74c3c; }
        
        .toggle-debug {
            position: fixed;
            top: 10px;
            right: 320px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            z-index: 10000;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Debug Panel Toggle -->
    <button class="toggle-debug" onclick="toggleDebugPanel()">Toggle Debug</button>
    
    <!-- Debug Control Panel -->
    <div id="debug-panel" class="debug-panel">
        <h3 style="margin: 0 0 15px 0; color: #3498db; text-align: center;">üêõ Debug Control Panel</h3>
        
        <!-- System Status -->
        <div class="debug-section">
            <h4>üìä System Status</h4>
            <div id="system-status">
                <div><span class="status-indicator status-ok"></span>Loading...</div>
            </div>
            <button class="debug-btn" onclick="checkSystemStatus()">Refresh Status</button>
        </div>
        
        <!-- Tutorial Controls -->
        <div class="debug-section">
            <h4>üéì Tutorial System</h4>
            <button class="debug-btn success" onclick="startTutorial()">Start Tutorial</button>
            <button class="debug-btn" onclick="resetTutorial()">Reset Tutorial</button>
            <button class="debug-btn warning" onclick="skipToStep('building_tutorial')">Skip to Building Tutorial</button>
            <button class="debug-btn warning" onclick="skipToStep('settlement')">Skip to Settlement</button>
            <div class="debug-info" id="tutorial-status">Tutorial Status: Not Started</div>
        </div>
        
        <!-- Game State Controls -->
        <div class="debug-section">
            <h4>üéÆ Game State</h4>
            <button class="debug-btn success" onclick="addResources()">+100 All Resources</button>
            <button class="debug-btn" onclick="advanceDay()">Advance Day</button>
            <button class="debug-btn" onclick="triggerConstruction()">Complete Construction</button>
            <button class="debug-btn warning" onclick="resetGame()">Reset Game</button>
            <div class="debug-info" id="game-state-info">Game Info Loading...</div>
        </div>
        
        <!-- Building System -->
        <div class="debug-section">
            <h4>üèóÔ∏è Building System</h4>
            <button class="debug-btn success" onclick="debugPlaceBuilding('townCenter')">Place Town Center</button>
            <button class="debug-btn success" onclick="debugPlaceBuilding('house')">Place House</button>
            <button class="debug-btn success" onclick="debugPlaceBuilding('farm')">Place Farm</button>
            <button class="debug-btn" onclick="showBuildingQueue()">Show Build Queue</button>
            <div class="debug-info" id="building-info">Buildings: Loading...</div>
        </div>
        
        <!-- Mini Modal Tests -->
        <div class="debug-section">
            <h4>üìã Mini Modal System</h4>
            <button class="debug-btn" onclick="testMiniModal()">Test Basic Modal</button>
            <button class="debug-btn" onclick="testBuildingModal()">Test Building Info</button>
            <button class="debug-btn" onclick="testToastSystem()">Test Mini Toasts</button>
            <button class="debug-btn danger" onclick="closeAllModals()">Close All Modals</button>
        </div>
        
        <!-- Console Log -->
        <div class="debug-section">
            <h4>üìù Debug Log</h4>
            <div class="debug-log" id="debug-log">Debug log will appear here...</div>
            <button class="debug-btn" onclick="clearLog()">Clear Log</button>
        </div>
    </div>

    <!-- Main Game Content -->
    <div id="app">
        <!-- Navigation -->
        <nav class="main-nav">
            <div class="nav-tabs">
                <button class="nav-tab active" data-view="village">üèòÔ∏è Village</button>
                <button class="nav-tab" data-view="battle">‚öîÔ∏è Battle</button>
                <button class="nav-tab" data-view="throne">üëë Throne</button>
                <button class="nav-tab" data-view="monarch">üéØ Monarch</button>
            </div>
        </nav>

        <!-- Resource Bar -->
        <div class="resource-bar">
            <div class="resource-item">
                <span class="resource-icon">üåæ</span>
                <span id="food-count">100</span>
            </div>
            <div class="resource-item">
                <span class="resource-icon">ü™µ</span>
                <span id="wood-count">50</span>
            </div>
            <div class="resource-item">
                <span class="resource-icon">ü™®</span>
                <span id="stone-count">25</span>
            </div>
            <div class="resource-item">
                <span class="resource-icon">‚öíÔ∏è</span>
                <span id="metal-count">10</span>
            </div>
            <div class="resource-item">
                <span class="resource-icon">üë•</span>
                <span id="population-count">10</span>
            </div>
            <div class="resource-item">
                <span class="resource-icon">üí∞</span>
                <span id="gold-count">1000</span>
            </div>
            <div class="resource-item">
                <span class="resource-icon">üåç</span>
                <span>Wave <span id="wave-count">1</span></span>
            </div>
            <div class="resource-item">
                <span class="resource-icon">üóìÔ∏è</span>
                <span id="season-display">Spring</span>
            </div>
        </div>

        <!-- Village View -->
        <div id="village-view" class="view-content active">
            <div class="village-controls">
                <div class="building-panel">
                    <h3>üèóÔ∏è Buildings</h3>
                    <div class="building-buttons">
                        <button class="building-btn" data-building="house">
                            <div class="building-icon">üè†</div>
                            <div class="building-name">House</div>
                            <div class="building-cost">Wood: 10</div>
                        </button>
                        <button class="building-btn" data-building="farm">
                            <div class="building-icon">üåæ</div>
                            <div class="building-name">Farm</div>
                            <div class="building-cost">Wood: 15, Stone: 5</div>
                        </button>
                        <button class="building-btn" data-building="townCenter">
                            <div class="building-icon">üèõÔ∏è</div>
                            <div class="building-name">Town Center</div>
                            <div class="building-cost">Wood: 50, Stone: 25</div>
                        </button>
                        <button class="building-btn" data-building="barracks">
                            <div class="building-icon">‚öîÔ∏è</div>
                            <div class="building-name">Barracks</div>
                            <div class="building-cost">Wood: 30, Stone: 20, Metal: 10</div>
                        </button>
                    </div>
                </div>
                
                <div class="time-controls">
                    <button id="end-day-btn" class="action-btn">‚è∞ End Day</button>
                    <div class="day-info">
                        <span>Day <span id="current-day">1</span></span>
                    </div>
                </div>
            </div>
            
            <div id="village-grid" class="village-grid">
                <!-- Buildings will be rendered here -->
            </div>
        </div>

        <!-- Other views (hidden initially) -->
        <div id="battle-view" class="view-content">
            <h2>‚öîÔ∏è Battle System</h2>
            <p>Battle system will be available here...</p>
        </div>

        <div id="throne-view" class="view-content">
            <h2>üëë Throne Room</h2>
            <p>Throne room will be available here...</p>
        </div>

        <div id="monarch-view" class="view-content">
            <h2>üéØ Monarch System</h2>
            <p>Monarch system will be available here...</p>
        </div>
    </div>

    <!-- Load Scripts -->
    <script src="src/eventBus.js"></script>
    <script src="src/modalSystem.js"></script>
    <script src="src/uiPopups.js"></script>
    <script src="src/gameState.js"></script>
    <script src="src/village.js"></script>
    <script src="src/tutorial.js"></script>
    <script src="src/app.js"></script>

    <script>
        // Debug System Implementation
        let debugLog = [];
        let game = null;
        
        // Override console.log to capture debug info
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            debugLog.push(args.join(' '));
            if (debugLog.length > 50) debugLog.shift(); // Keep last 50 entries
            updateDebugLog();
        };
        
        function updateDebugLog() {
            const logElement = document.getElementById('debug-log');
            if (logElement) {
                logElement.innerHTML = debugLog.slice(-10).join('<br>');
                logElement.scrollTop = logElement.scrollHeight;
            }
        }
        
        function clearLog() {
            debugLog = [];
            updateDebugLog();
        }
        
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }
        
        function checkSystemStatus() {
            const statusDiv = document.getElementById('system-status');
            let status = [];
            
            // Check if systems are loaded
            status.push(`<div><span class="status-indicator ${window.Game ? 'status-ok' : 'status-error'}"></span>Game Class: ${window.Game ? 'Loaded' : 'Missing'}</div>`);
            status.push(`<div><span class="status-indicator ${window.modalSystem ? 'status-ok' : 'status-error'}"></span>Modal System: ${window.modalSystem ? 'Ready' : 'Missing'}</div>`);
            status.push(`<div><span class="status-indicator ${window.showToast ? 'status-ok' : 'status-error'}"></span>Toast System: ${window.showToast ? 'Ready' : 'Missing'}</div>`);
            status.push(`<div><span class="status-indicator ${window.showMiniToast ? 'status-ok' : 'status-error'}"></span>Mini Toast: ${window.showMiniToast ? 'Ready' : 'Missing'}</div>`);
            status.push(`<div><span class="status-indicator ${window.TutorialManager ? 'status-ok' : 'status-error'}"></span>Tutorial: ${window.TutorialManager ? 'Ready' : 'Missing'}</div>`);
            
            statusDiv.innerHTML = status.join('');
        }
        
        function startTutorial() {
            if (game && game.tutorialManager) {
                console.log('[Debug] Starting tutorial...');
                game.tutorialManager.showIntro();
                updateTutorialStatus();
            } else {
                console.error('[Debug] Tutorial manager not available');
            }
        }
        
        function resetTutorial() {
            localStorage.removeItem('dynasty_name');
            localStorage.removeItem('tutorial_completed');
            console.log('[Debug] Tutorial data cleared');
            if (game && game.tutorialManager) {
                game.tutorialManager.currentStep = 0;
                game.tutorialManager.completedSteps.clear();
                game.tutorialManager.dynastyName = null;
            }
            updateTutorialStatus();
        }
        
        function skipToStep(stepId) {
            if (game && game.tutorialManager) {
                console.log(`[Debug] Skipping to tutorial step: ${stepId}`);
                game.tutorialManager.startStep(stepId);
                updateTutorialStatus();
            }
        }
        
        function updateTutorialStatus() {
            const element = document.getElementById('tutorial-status');
            if (game && game.tutorialManager) {
                const currentStep = game.tutorialManager.steps[game.tutorialManager.currentStep];
                element.innerHTML = `Current Step: ${currentStep ? currentStep.id : 'None'}<br>Dynasty: ${game.tutorialManager.getDynastyName()}`;
            } else {
                element.innerHTML = 'Tutorial Manager: Not Available';
            }
        }
        
        function addResources() {
            if (game && game.gameState) {
                console.log('[Debug] Adding resources...');
                game.gameState.resources.food += 100;
                game.gameState.resources.wood += 100;
                game.gameState.resources.stone += 100;
                game.gameState.resources.metal += 100;
                game.gameState.gold += 100;
                game.gameState.updateUI();
                updateGameStateInfo();
            }
        }
        
        function advanceDay() {
            if (game && game.gameState) {
                console.log('[Debug] Advancing day...');
                game.gameState.processDailyResources();
                game.gameState.processPopulationGrowth();
                game.gameState.processBuildingConstruction(24); // Advance by 24 hours
                game.gameState.currentDay++;
                game.gameState.updateUI();
                updateGameStateInfo();
            }
        }
        
        function triggerConstruction() {
            if (game && game.gameState && game.gameState.buildingQueue.length > 0) {
                console.log('[Debug] Completing all construction...');
                game.gameState.buildingQueue.forEach(building => {
                    building.hoursRemaining = 0;
                });
                game.gameState.processBuildingConstruction(1);
                updateGameStateInfo();
            } else {
                console.log('[Debug] No buildings in construction queue');
            }
        }
        
        function resetGame() {
            if (confirm('Reset all game data?')) {
                localStorage.clear();
                location.reload();
            }
        }
        
        function updateGameStateInfo() {
            const element = document.getElementById('game-state-info');
            if (game && game.gameState) {
                const gs = game.gameState;
                element.innerHTML = `Day: ${gs.currentDay} | Buildings: ${gs.buildings.length} | Queue: ${gs.buildingQueue.length}<br>Resources: F:${gs.resources.food} W:${gs.resources.wood} S:${gs.resources.stone}`;
            }
        }
        
        function debugPlaceBuilding(type) {
            if (game && game.village) {
                console.log(`[Debug] Placing ${type} building...`);
                const x = 100 + Math.random() * 200;
                const y = 100 + Math.random() * 200;
                game.gameState.queueBuilding(type, x, y);
                updateGameStateInfo();
            }
        }
        
        function showBuildingQueue() {
            if (game && game.gameState) {
                const queue = game.gameState.buildingQueue;
                if (queue.length > 0) {
                    const queueInfo = queue.map(b => `${b.type} (${Math.ceil(b.hoursRemaining)}h left)`).join(', ');
                    alert(`Building Queue: ${queueInfo}`);
                } else {
                    alert('No buildings in construction queue');
                }
            }
        }
        
        function updateBuildingInfo() {
            const element = document.getElementById('building-info');
            if (game && game.gameState) {
                element.innerHTML = `Built: ${game.gameState.buildings.length} | Queue: ${game.gameState.buildingQueue.length}`;
            }
        }
        
        function testMiniModal() {
            if (window.modalSystem && window.modalSystem.showMiniModal) {
                window.modalSystem.showMiniModal({
                    title: 'Debug Test',
                    content: `
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 10px;">üêõ</div>
                            <div style="color: #2ecc71; font-weight: bold;">Mini Modal Test</div>
                            <div style="color: #bdc3c7; font-size: 12px; margin-top: 5px;">System working correctly!</div>
                            <div style="margin-top: 10px; padding: 8px; background: rgba(52, 152, 219, 0.2); border-radius: 4px;">
                                <div style="color: #3498db; font-size: 11px;">‚úì Positioning: Dynamic</div>
                                <div style="color: #3498db; font-size: 11px;">‚úì Animation: Smooth</div>
                                <div style="color: #3498db; font-size: 11px;">‚úì Closing: Multiple methods</div>
                            </div>
                        </div>
                    `,
                    width: '250px',
                    autoClose: true,
                    autoCloseDelay: 5000
                });
                console.log('[Debug] Mini modal test launched');
            } else {
                alert('Mini modal system not available');
            }
        }
        
        function testBuildingModal() {
            if (game && game.gameState && game.gameState.buildings.length > 0) {
                const building = game.gameState.buildings[0];
                if (game.village) {
                    game.village.showBuildingInfo(building);
                    console.log('[Debug] Building modal test with real building');
                }
            } else {
                // Create fake building for test
                const fakeBuilding = {
                    id: 'test_building',
                    type: 'house',
                    level: 2,
                    x: 100,
                    y: 100
                };
                
                if (window.modalSystem && window.modalSystem.showMiniModal) {
                    window.modalSystem.showMiniModal({
                        title: 'Test Building Info',
                        content: `
                            <div style="text-align: center; margin-bottom: 10px;">
                                <div style="font-size: 24px; margin-bottom: 5px;">üè†</div>
                                <div style="font-weight: bold; color: #3498db;">HOUSE</div>
                                <div style="color: #bdc3c7; font-size: 12px;">Level 2</div>
                            </div>
                            <div style="margin-bottom: 10px;">
                                <div style="color: #2ecc71; font-weight: bold; font-size: 12px; margin-bottom: 4px;">üìä PRODUCTION:</div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: #ecf0f1; font-size: 11px;">üë• population</span>
                                    <span style="color: #2ecc71; font-weight: bold; font-size: 11px;">+10</span>
                                </div>
                            </div>
                            <div style="background: rgba(52, 152, 219, 0.2); padding: 6px; border-radius: 4px; text-align: center;">
                                <div style="color: #3498db; font-size: 11px;">üîß Upgrade feature coming soon!</div>
                            </div>
                        `,
                        width: '280px'
                    });
                    console.log('[Debug] Building modal test with fake data');
                }
            }
        }
        
        function testToastSystem() {
            console.log('[Debug] Testing toast systems...');
            
            // Test mini toasts
            if (window.showMiniToast) {
                setTimeout(() => window.showMiniToast('üéâ', 'Test!'), 100);
                setTimeout(() => window.showResourceChange('food', 25), 300);
                setTimeout(() => window.showResourceChange('wood', -10), 500);
                setTimeout(() => window.showBuildingComplete('house'), 700);
            }
            
            // Test regular toast
            if (window.showToast) {
                setTimeout(() => {
                    window.showToast('Debug toast system test completed!', {
                        icon: 'üêõ',
                        type: 'success',
                        timeout: 3000
                    });
                }, 1000);
            }
        }
        
        function closeAllModals() {
            if (window.modalSystem) {
                window.modalSystem.closeAllModals();
                window.modalSystem.closeMiniModals();
                console.log('[Debug] All modals closed');
            }
        }
        
        // Initialize debug system when game loads
        window.addEventListener('DOMContentLoaded', () => {
            console.log('[Debug] Debug system initializing...');
            
            // Wait for game to initialize
            setTimeout(() => {
                if (window.Game) {
                    game = new Game();
                    window.debugGame = game; // Make available globally
                    console.log('[Debug] Game instance created and available as window.debugGame');
                } else {
                    console.error('[Debug] Game class not found');
                }
                
                checkSystemStatus();
                updateTutorialStatus();
                updateGameStateInfo();
                updateBuildingInfo();
                
                // Update info periodically
                setInterval(() => {
                    updateGameStateInfo();
                    updateBuildingInfo();
                }, 2000);
                
            }, 1000);
        });
    </script>
</body>
</html>
